# توثيق نظام المصادقة وإدارة الجلسات (Centralized Auth & Session System)

يغطي هذا المستند البنية التحتية الجديدة لنظام المصادقة في المشروع، والتي تعتمد على المركزية، الموديولية (Modularity)، وفصل المهام (Separation of Concerns).

---

## 1. البنية التحتية والوحدات المركزية (`js/auth/`)

تم نقل المنطق المشتت سابقاً إلى ثلاث وحدات أساسية تعمل معاً:

### أ. مدير الجلسة (`sessionManager.js`)
هو "مصدر الحقيقة" الوحيد والمتحكم في حالة المستخدم.
*   **الحالة (State)**: يدير `window.userSession` تلقائياً ويضمن مزامنتها مع `localStorage`.
*   **الوظائف الرئيسية**:
    *   `init()`: تُستدعى عند بدء التطبيق (`index.js`) قراءة الجلسة، تحديث الواجهة، وتهيئة الإشعارات.
    *   `login(user, redirect)`: معالجة الدخول الناجح، حفظ البيانات، تفعيل FCM، والتوجيه التلقائي.
    *   `logout()`: عملية خروج آمنة شاملة (مسح localStorage، IndexedDB، إعلام تطبيق Android، وتفريغ الحاويات).
    *   `updateUser(updates)`: تحديث بيانات الجلسة الحالية ومزامنة الاسم في الهيدر فوراً.
    *   **انتحال الشخصية (Impersonation)**:
        *   `impersonate(targetUser)`: تبديل الهوية مع حفظ جلسة المسؤول الأصلية.
        *   `isImpersonating()`: التحقق من وضع التصفح بصلاحيات مستخدم آخر.

### ب. المدقق الموحد (`validators.js` - `AuthValidators`)
يحتوي على كافة قواعد التحقق من المدخلات لضمان اتساق البيانات.
*   `validatePhone(phone)`: التحقق من طول وصيغة رقم الهاتف وتطبيعه (Normalization).
*   `validatePassword(pass)`: حد أدنى 4 أحرف.
*   `validateUsername(name)`: اسم حقيقي (3-30 حرف).
*   `validateAddress(address, hasCoordinates)`: تتحقق من وجود العنوان. إذا توفرت الإحداثيات، تعيد حالة نجاح نصية تتيح للواجهة عرض رسائل الشكر والتفاصيل الذكية.
*   `normalizePhone(phone)`: تحويل الأرقام (٠-٩) وحذف الرموز غير الرقمية.

### ج. مساعد الواجهة (`uiHelpers.js` - `AuthUI`)
يوفر طبقة تجريد (Abstraction) لمكتبة `SweetAlert2` لتسهيل الاستخدام وتوحيد المظهر.
*   `showLoading(msg)` / `close()`: إدارة شاشات التحميل.
*   `showError`, `showSuccess`: عرض التنبيهات.
*   `confirmPassword()`: نافذة منبثقة تطلب كلمة المرور للتحقق قبل الإجراءات الحساسة.
*   `showFieldValidationMsg()`: إظهار رسائل الخطأ أسفل حقول الإدخال مباشرة.

---

## 2. تدفق العمليات (Workflows)

### أ. تسجيل الدخول (`pages/login/login.js`)
1.  التحقق من المدخلات عبر `AuthValidators`.
2.  استدعاء API `verifyUserPassword`.
3.  عند النجاح، استدعاء `SessionManager.login(userData)` الذي يتولى كل شيء (الحفظ، الإشعارات، التوجيه).
4.  الدخول كضيف يستخدم نفس مسار `login` مع كائن "Guest".

### ب. إنشاء حساب (`pages/register/register.js`)
1.  تدقيق البيانات عبر `AuthValidators` (تم إدراج العنوان كحقل إلزامي مع دعم `hasCoordinates`).
2.  **تكامل الخريطة وقفل النافذة**: 
    *   يتم فتح الخريطة في SweetAlert2 مع قفل الإغلاق العرضي (يغلق من زر X فقط).
    *   **دعم التزامن**: يستمع المستمع لثلاث رسائل أساسية عبر `postMessage`:
        *   `LOCATION_SELECTED`: لتأكيد اختيار الموقع.
        *   `LOCATION_RESET`: لمسح الموقع وإعادة الواجهة لحالتها الافتراضية.
        *   `CLOSE_LOCATION_MODAL`: لإغلاق النافذة.
3.  **الرسائل الذكية (Smart UI)**: 
    *   إذا كان حقل العنوان يحتوي على نص، يظهر "تم ربط الموقع بنجاح" فقط.
    *   إذا كان الحقل فارغاً، يظهر تلميح بضرورة كتابة تفاصيل (الدور، الشقة... إلخ).
4.  تأكيد كلمة المرور عبر نافذة من `AuthUI`.
5.  استدعاء API `addUser` مع إرسال الإحداثيات في حقل `coords`.

### ج. الملف الشخصي (`pages/profile-modal/profile-modal.js`)
1.  تدقيق التعديلات عبر `AuthValidators` مع تمرير حالة وجود إحداثيات.
2.  **استعادة الموقع والتهيئة الذكية**: يتم التحقق تلقائياً من `userSession.coordinates` أو `localStorage`. يتم تفعيل "الرسائل الذكية" أيضاً عند التحميل؛ فإذا وجد نص للعنوان لا تظهر رسالة التذكير الطويلة.
3.  **الحفظ الصامت**: زر الإغلاق (X) في الخريطة يقوم بحفظ الموقع المختار صامتاً قبل الإغلاق لضمان عدم ضياع مجهود المستخدم.
4.  تحديث الجلسة والواجهة فوراً عبر `SessionManager.updateUser`.
5.  الحذف يتطلب تأكيداً نهائياً بكلمة المرور ثم استدعاء `SessionManager.logout`.

### د. لوحة التحكم (`js/user-dashboard.js`)
*   تعتمد كلياً على `SessionManager` للتحقق من الأدوار (Guest vs. Real User).
*   تستخدم `SessionManager.isImpersonating()` لعرض علامة "وضع المسؤول" المائية (Watermark).

---

## 3. التوافقية والأمان
*   **التوافقية (Backward Compatibility)**: يظل `window.userSession` متاحاً عالمياً لضمان عدم تعطل الأجزاء القديمة من الكود، ولكن يمنع تعديله يدوياً؛ يجب استخدام `SessionManager`.
*   **الأمان**: يتم التحقق من كلمة المرور (Re-authentication) قبل:
    *   حفظ تغييرات الملف الشخصي (إذا وجدت كلمة مرور).
    *   حذف الحساب.
    *   بدء عملية انتحال الشخصية.
*   **تعدد المنصات**: منطق الخروج (`logout`) مدمج فيه استدعاءات `window.Android` لضمان مزامنة حالة الخروج مع تطبيق الأندرويد.
