# توثيق نظام المصادقة وإدارة الجلسات (Centralized Auth & Session System)

يغطي هذا المستند البنية التحتية الجديدة لنظام المصادقة في المشروع، والتي تعتمد على المركزية، الموديولية (Modularity)، وفصل المهام (Separation of Concerns).

---

## 0. الإعدادات المركزية (`js/config.js`)

يعتبر هذا الملف العصب المركزي لإعدادات التطبيق، حيث يضمن اتساق العمل بين البيئات المختلفة (المحلية، الحساب التجريبي، والتطبيق):

*   **إدارة العناوين (API Base URL)**: 
    *   يحدد `baseURL` تلقائياً بناءً على `location.hostname` ومصفوفة `allowedHosts`.
    *   يضمن توجيه كافة الطلبات إلى السيرفر الصحيح (Vercel أو Localhost) دون تعديل يدوي في الكود.
*   **إدارة المسؤولين (`ADMIN_IDS`)**:
    *   يحتوي على المصفوفة الرسمية للمعرفات الفريدة (`user_key`) التي تملك صلاحيات إدارة النظام.
    *   يتم استهلاك هذه المصفوفة في `user-dashboard.js` لفتح لوحة التحكم، وفي `view_init.js` لإظهار بيانات البائعين للمسؤولين فقط.
    *   **ملاحظة**: تم استبدال نظام التحقق برقم الهاتف بهذا النظام الأكثر أماناً لضمان عدم تداخل الصلاحيات.

---

## 1. البنية التحتية والوحدات المركزية (`js/auth/`)

تم نقل المنطق المشتت سابقاً إلى ثلاث وحدات أساسية تعمل معاً:

### أ. مدير الجلسة (`sessionManager.js`)
هو "مصدر الحقيقة" الوحيد والمتحكم في حالة المستخدم.
*   **الحالة (State)**: يدير `window.userSession` تلقائياً ويضمن مزامنتها مع `localStorage`.
*   **الوظائف الرئيسية**:
    *   `init()`: تُستدعى عند بدء التطبيق (`index.js`) قراءة الجلسة، تحديث الواجهة، وتهيئة الإشعارات.
    *   `login(user, redirect)`: معالجة الدخول الناجح، حفظ البيانات، تفعيل FCM، والتوجيه التلقائي.
    *   `logout()`: عملية خروج آمنة شاملة (مسح localStorage، IndexedDB، إعلام تطبيق Android، وتفريغ الحاويات).
    *   `updateUser(updates)`: تحديث بيانات الجلسة الحالية ومزامنة الاسم في الهيدر فوراً.
    *   **انتحال الشخصية (Impersonation)**:
        *   `impersonate(targetUser)`: تبديل الهوية مع حفظ جلسة المسؤول الأصلية.
        *   `isImpersonating()`: التحقق من وضع التصفح بصلاحيات مستخدم آخر.

### ب. المدقق الموحد (`validators.js` - `AuthValidators`)
يحتوي على كافة قواعد التحقق من المدخلات لضمان اتساق البيانات.
*   `validatePhone(phone)`: التحقق من طول وصيغة رقم الهاتف وتطبيعه (Normalization).
*   `validatePassword(pass)`: حد أدنى 4 أحرف.
*   `validateUsername(name)`: اسم حقيقي (3-30 حرف).
*   `validateAddress(address, hasCoordinates)`: تتحقق من وجود العنوان. إذا توفرت الإحداثيات، تعيد حالة نجاح نصية تتيح للواجهة عرض رسائل الشكر والتفاصيل الذكية.
*   `normalizePhone(phone)`: تحويل الأرقام (٠-٩) وحذف الرموز غير الرقمية.

### ج. مساعد الواجهة (`uiHelpers.js` - `AuthUI`)
يوفر طبقة تجريد (Abstraction) لمكتبة `SweetAlert2` لتسهيل الاستخدام وتوحيد المظهر.
*   `showLoading(msg)` / `close()`: إدارة شاشات التحميل.
*   `showError`, `showSuccess`: عرض التنبيهات.
*   `confirmPassword()`: نافذة منبثقة تطلب كلمة المرور للتحقق قبل الإجراءات الحساسة.
*   `showFieldValidationMsg()`: إظهار رسائل الخطأ أسفل حقول الإدخال مباشرة.

---

## 2. تدفق العمليات (Workflows)

### أ. تسجيل الدخول (`pages/login/login.js`)
1.  التحقق من المدخلات عبر `AuthValidators`.
2.  استدعاء API `verifyUserPassword`.
3.  عند النجاح، استدعاء `SessionManager.login(userData)` الذي يتولى كل شيء (الحفظ، الإشعارات، التوجيه).
4.  الدخول كضيف يستخدم نفس مسار `login` مع كائن "Guest".

### ب. إنشاء حساب (`pages/register/register.js`)
1.  تدقيق البيانات عبر `AuthValidators` (تم إدراج العنوان كحقل إلزامي مع دعم `location`).
2.  **تكامل الخريطة وقفل النافذة**: 
    *   يتم فتح الخريطة في SweetAlert2 مع قفل الإغلاق العرضي (يغلق من زر X فقط).
    *   يتم إرسال الإحداثيات عبر `postMessage` لنموذج التسجيل ليتم تخزينها مؤقتاً في الصفحة.
3.  **الرسائل الذكية (Smart UI)**: تعتمد على وجود نص في حقل العنوان أو وجود إحداثيات محددة.
4.  تأكيد كلمة المرور عبر نافذة من `AuthUI`.
5.  **التحديث دفعة واحدة (Batch Update)**: عند الضغط على "إنشاء حساب"، يتم إرسال كافة البيانات (الاسم، الهاتف، العنوان، الموقع) في طلب API واحد (`addUser`) لضمان الكفاءة.

### ج. الملف الشخصي (`pages/profile-modal/profile-modal.js`)
1.  تدقيق التعديلات عبر `AuthValidators` مع تمرير حالة وجود إحداثيات.
2.  **استعادة البيانات**: يتم جلب الموقع ضمن كائن بيانات المستخدم مرة واحدة عند تسجيل الدخول (`userSession.location`).
3.  **تحديث محلي أولاً**: عند اختيار موقع جديد من الخريطة، يتم تحديث واجهة الملف الشخصي فقط (تحديث حقل `profile-coords` المخفي) دون إرسال أي بيانات للسيرفر.
4.  **الرسائل الذكية (Smart UI)**: 
    *   يتم استدعاء `AuthValidators.validateAddress` للتحقق من النص يدوياً.
    *   إذا اختار المستخدم موقعاً، يتغير لون زر الموقع وتظهر رسالة نجاح خضراء.
    *   الرسالة تتغير في `profileInitializeData`؛ فإذا كان العنوان مسجلاً مسبقاً تظهر رسالة "تم ربط الموقع"، وإذا كان فارغاً تطلب من المستخدم كتابة تفاصيل إضافية.
5.  **الحفظ النهائي السحابي**: يتم إرسال التحديثات (بما فيها الموقع الجديد إذا وُجد في حقل `location`) كدفعة واحدة للسيرفر فقط عند الضغط على زر "حفظ التغييرات".
6.  تحديث الجلسة والواجهة فوراً عبر `SessionManager.updateUser`.
7.  الحذف يتطلب تأكيداً نهائياً بكلمة المرور ثم استدعاء `SessionManager.logout`.

### د. لوحة التحكم (`js/user-dashboard.js`)
*   تعتمد كلياً على `SessionManager` للتحقق من الأدوار (Guest vs. Real User).
*   تستخدم `SessionManager.isImpersonating()` لعرض علامة "وضع المسؤول" المائية (Watermark).

---

## 3. التوافقية والأمان
*   **التوافقية (Backward Compatibility)**: يظل `window.userSession` متاحاً عالمياً لضمان عدم تعطل الأجزاء القديمة من الكود، ولكن يمنع تعديله يدوياً؛ يجب استخدام `SessionManager`.
*   **الأمان**: يتم التحقق من كلمة المرور (Re-authentication) قبل:
    *   حفظ تغييرات الملف الشخصي (إذا وجدت كلمة مرور).
    *   حذف الحساب.
    *   بدء عملية انتحال الشخصية.
*   **تعدد المنصات**: منطق الخروج (`logout`) مدمج فيه استدعاءات `window.Android` لضمان مزامنة حالة الخروج مع تطبيق الأندرويد.

# دليل التوجيه والتحميل الديناميكي (Routing & Dynamic Loading)

يعتمد مشروع "بزار" على بنية **تطبيق الصفحة الواحدة (Single Page Application - SPA)**، حيث يتم التنقل بين الصفحات دون إعادة تحميل المتصفح بالكامل. يتم إدارة هذه العملية عبر محرك التحميل الموجود في `js/forms.js`.

---

## 1. دالة التحميل الأساسية: `mainLoader`

تُعد `mainLoader` القلب النابض للتنقل في المشروع. تقوم بجلب محتوى HTML من السيرفر وحقنه في حاوية محددة مع إدارة السكربتات والتنسيقات تلقائياً.

### التوقيع البرمجي (Signature):
```javascript
async function mainLoader(pageUrl, containerId, waitMs, cssRules, callbackName, reload)
```

### المعايير (Parameters):
1. **`pageUrl`**: مسار ملف الـ HTML المطلوب تحميله (مثال: `./pages/home.html`).
2. **`containerId`**: معرف (ID) العنصر الذي سيتم عرض المحتوى بداخله (مثل: `index-home-container`).
3. **`waitMs`** (اختياري - افتراضي `300`): وقت الانتظار بالملي ثانية قبل إظهار المحتوى (لضمان سلاسة الانتقال).
4. **`cssRules`** (اختياري): قواعد CSS نصية يتم تطبيقها حصراً على هذه الحاوية.
5. **`callbackName`** (اختياري): اسم دالة (أو مصفوفة أسماء) معرفة عالمياً (window) يتم تنفيذها فور اكتمال التحميل.
6. **`reload`** (اختياري - افتراضي `false`): إذا كانت `true` يتم إجبار النظام على إعادة جلب الملف من السيرفر ومسح المحتوى القديم تماًماً.

### تقنية "التخزين المزدوج" (Double Buffering):
تعمل الدالة داخلياً بنظام Buffer؛ حيث يتم تحميل المحتوى في حاوية مخفية أولاً، ومعالجة السكربتات بداخلها، ثم نقلها فجأة للحاوية الظاهرة، مما يمنع ظهور المحتوى غير المنسق (FOUC).

### معالجة السكربتات (Script IIFE Wrapping):
لمنع خطأ "Identifier has already been declared" عند إعادة تحميل الصفحات، تقوم الدالة بتغليف كل سكربت داخل:
```javascript
(function() { 
   // كود الصفحة هنا 
})();
```
هذا يضمن أن المتغيرات المعرفة بـ `let` أو `const` تبقى محصورة في "جلسة التحميل" الحالية.

---

## 2. دالة العودة للخلف: `containerGoBack`

تستخدم هذه الدالة لإدارة "تاريخ التنقل" داخل الحاويات المسجلة في `LOADER_REGISTRY`.

### طريقة العمل:
1. تقوم بحذف الحاوية الحالية من السجل ومسح محتواها من الـ DOM لتوفير الذاكرة.
2. تقوم بإظهار الحاوية السابقة التي كانت مفتوحة قبلها مباشرة.

### مثال للاستخدام:
```javascript
// يتم استدعاؤها عادة عند النقر على زر "رجوع" في الواجهة
if (!containerGoBack()) {
    console.warn("لا توجد صفحات سابقة للعودة إليها");
}
```

---

## 3. سجل الحاويات (`LOADER_REGISTRY`)

يقوم النظام بتسجيل كل `containerId` يتم تحميله داخل مصفوفة عالمية.
* **الأهمية:** منع تكرار تحميل نفس الصفحة إذا كانت موجودة بالفعل في الخلفية، مما يوفر استهلاك البيانات ويزيد السرعة.
* **الإدارة التلقائية:** عند فتح حاوية جديدة، تقوم `mainLoader` بإخفاء كافة الحاويات المسجلة الأخرى تلقائياً.

---

## 4. أفضل الممارسات (Best Practices)

* **استخدام `reload: true`:** استخدمها فقط عند الحاجة لتحديث البيانات من السيرفر (مثل العودة لصفحة "منتجاتي" بعد إضافة منتج جديد).
* **دوال الـ Callback:** يفضل دائماً تمرير اسم الدالة كـ String لضمان استدعائها من النطاق العالمي (Window Context).
* **تسمية الحاويات:** يفضل توحيد بادئة الحاويات (مثل `index-XXXX-container`) للتنظيم.

