# دليل تطبيق نظام تحديد الموقع (BidStory Location)

هذا المستند يشرح بنية ونظام عمل تطبيق تحديد الموقع الجغرافي، والذي تم إعادة هيكلته ليعمل بنظام الوحدات (Modules) لضمان سهولة الصيانة والتطوير.

## هيكل المجلدات والملفات

تم تقسيم الكود إلى مجلد `js/location/` يحتوي على الملفات التالية:

| الملف | الوصف |
| :--- | :--- |
| `config.js` | يحتوي على تعريف الكائن الرئيسي `location_app` والثوابت (مثل الإحداثيات الافتراضية ومستوى التكبير). |
| `ui.js` | مسؤول عن عناصر الواجهة مثل شاشات التحميل (Loading) والتنبيهات (SweetAlert2). |
| `storage.js` | يدير تخزين الموقع المختار في `localStorage` والتحقق من صحة الإحداثيات. |
| `map.js` | يحتوي على منطق تهيئة خريطة Leaflet، إضافة العلامات (Markers)، والتعامل مع النقر المزدوج والضغط المطول. |
| `gps.js` | يدير خدمة تحديد الموقع عبر GPS والتعامل مع الأذونات والأخطاء الناتجة عنها. |
| `utils.js` | يحتوي على وظائف إضافية مثل مشاركة الإحداثيات (نسخ أو فتح في الخرائط) وإعادة تعيين الموقع. |
| `core.js` | يحتوي على دالة التهيئة الرئيسية `init` التي تربط جميع الوحدات ببعضها. |
| `location_app.js` | هو نقطة الدخول (Entry Point) التي تطلق التطبيق عند تحميل الصفحة وتدير الأخطاء الشاملة. |

## المميزات الرئيسية

1. **نظام الحفظ اليدوي (Manual Save)**: لا يتم الحفظ أو الإغلاق تلقائياً عند النقر. يجب على المستخدم الضغط على زر "حفظ" لتأكيد الموقع وإرساله للنافذة الأم، مما يمنح تحكماً كاملاً.
2. **أزرار تحكم عصرية**:
   - **زر حفظ (Save)**: يبرز باللون الأخضر (Success) لتأكيد الحفظ.
   - **زر إغلاق (Close)**: زر دائري عصري (X) في زاوية الشاشة يقوم بحفظ الموقع المختار صامتاً (بدون رسائل) ثم غلق النافذة، مما يسرع عملية الاختيار.
3. **دعم GPS محسّن**: الحصول على الموقع الدقيق بضغطة زر مع عرض دائرة الدقة. تم تحسين وقت الانتظار (30 ثانية) لدعم أفضل على الموبايل والمتصفحات.
4. **تصميم عصري مستجيب**: 
   - أزرار تحكم مرتبة في حاوية عائمة (Floating Panel) بزوايا مستديرة وظل عميق.
   - تظهر في صف واحد دائماً حتى على الهواتف مع دعم التمرير الأفقي (Horizontal Scroll).
5. **تخزين محلي ومعرفات فريدة**: يتم حفظ آخر موقع، وجميع عناصر الواجهة تمتلك معرفات (IDs) فريدة لتسهيل الاختبار والتعرف البرمجي.
6. **خيارات المشاركة المتقدمة**: نسخ الإحداثيات أو فتح الموقع مباشرة في تطبيق الخرائط.

## التواصل مع النافذة الأم (Parent Communication)

يعمل التطبيق داخل `iframe` ويتواصل مع الصفحة الرئيسية عبر `window.postMessage`:
- **`LOCATION_SELECTED`**: تُرسل عند الضغط على زر "حفظ" وتحتوي على الإحداثيات.
- **`CLOSE_LOCATION_MODAL`**: تُرسل عند الضغط على زر الإغلاق (X) لطلب غلق النافذة من الصفحة الأم.

## المعايير التقنية والمطابقة

- **بدون تأثيرات تمرير (No Hover)**: جميع التفاعلات تعتمد على النقرات أو الضغط المطول، دون الاعتماد على حالة Hover لضمان التوافق مع اللمس.
- **ألوان مسطحة (Flat Colors)**: الالتزام بالألوان الصلبة والابتعاد عن التدرجات اللونية (No Gradients).
- **التوثيق**: جميع الوظائف موثقة باستخدام **JSDoc** باللغة الإنجليزية، بينما نصوص الواجهة باللغة العربية بالكامل.
- **حجم الخط الصغير للحقوق**: تم تصغير نص الحقوق الخاص بالخريطة (`leaflet-control-attribution`) لزيادة المساحة المرئية.

## التوافق مع WebView (Android)

التطبيق مُحسّن للعمل داخل WebView في تطبيقات أندرويد:
- دعم كامل لـ Geolocation API
- timeout محسّن (30 ثانية) للحصول على إشارة GPS في الأماكن الضعيفة
- دعم الأحداث اللمسية (touch events) والضغط المطول
- تصميم مستجيب يتكيف مع جميع أحجام الشاشات

> [!IMPORTANT]
> عند استخدام التطبيق في WebView، تأكد من:
> - إضافة أذونات الموقع في `AndroidManifest.xml`
> - تفعيل JavaScript و Geolocation في إعدادات WebView
> - تطبيق `WebChromeClient` لمعالجة طلبات الموقع

## كيفية الاستخدام البرمجي

يتم تحميل الملفات بالترتيب التالي في `location\LOCATION.html`:
1. `js/location/config.js`
2. `js/location/ui.js`
3. `js/location/storage.js`
4. `js/location/map.js`
5. `js/location/gps.js`
6. `js/location/utils.js`
7. `js/location/core.js`
8. `location_app.js`

> [!IMPORTANT]
> المتطلبات الخارجية: Leaflet JS, SweetAlert2, Material Icons.
