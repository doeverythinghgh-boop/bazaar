<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: adverModule.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: adverModule.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file js/adverModule.js
 * @description موديول لعرض شريط إعلانات متحرك (Hero Slider).
 *
 * يقوم هذا الموديول بجلب الصور الإعلانية من رابط عام وعرضها
 * في حاوية محددة كشريط إعلاني ينتقل تلقائيًا.
 */

/**
 * @description تهيئة وعرض موديول الإعلانات.
 *   يقوم بجلب الصور الإعلانية من الذاكرة المؤقتة المحلية أو من الخادم، ثم يقوم ببناء وعرض شريط تمرير (Slider) للإعلانات.
 *   يدعم آلية التخزين المؤقت لتجنب جلب البيانات بشكل متكرر.
 * @function initAdverModule
 * @param {string} containerId - المعرف (ID) لعنصر DOM الذي سيحتوي على شريط الإعلانات.
 * @param {boolean} [forceRefresh=false] - إذا كان `true`، سيتم تجاوز الذاكرة المؤقتة وجلب الإعلانات من الخادم مباشرة.
 * @returns {Promise&lt;void>} - وعد (Promise) لا يُرجع قيمة عند الاكتمال.
 * @see getLatestUpdate
 * @see buildSlider
 */
async function initAdverModule(containerId, forceRefresh = false) {
  const container = document.getElementById(containerId);
  if (!container) {
    console.error(`[AdverModule] لم يتم العثور على الحاوية بالمعرف: ${containerId}`);
    return;
  }

  console.log('%c[AdverModule] Initializing...', 'color: #20c997');

  // --- ✅ جديد: منطق التخزين المؤقت (Caching) ---
  const CACHE_KEY_IMAGES = 'adver_images_cache';
  const CACHE_KEY_TIMESTAMP = 'adver_timestamp_cache';
  const CACHE_KEY_LAST_CHECK = 'adver_last_check_timestamp'; // ✅ جديد: لتخزين وقت آخر فحص
  const CHECK_INTERVAL = 24 * 60 * 60 * 1000; // 24 ساعة بالمللي ثانية

  const cachedTimestamp = localStorage.getItem(CACHE_KEY_TIMESTAMP);
  const cachedImages = JSON.parse(localStorage.getItem(CACHE_KEY_IMAGES));
  const lastCheckTimestamp = localStorage.getItem(CACHE_KEY_LAST_CHECK);

  // ✅ جديد: التحقق مما إذا كان يجب استخدام النسخة المخبأة دون الاتصال بالخادم
  if (!forceRefresh &amp;&amp; lastCheckTimestamp &amp;&amp; (Date.now() - lastCheckTimestamp &lt; CHECK_INTERVAL) &amp;&amp; cachedImages &amp;&amp; cachedImages.length > 0) {
    console.log('%c[AdverModule] Loading ads from cache (within 24h interval).', 'color: green; font-weight: bold;');
    buildSlider(container, cachedImages);
    return; // توقف هنا، لا حاجة للاتصال بالخادم
  }

  // جلب آخر تاريخ تحديث من الخادم
  console.log('%c[AdverModule] Checking for updates from server (interval elapsed or no cache).', 'color: #17a2b8;');
  const latestUpdate = await getLatestUpdate();
  const serverTimestamp = latestUpdate ? latestUpdate.datetime : null;

  console.log(`[AdverModule] Server Timestamp: ${serverTimestamp}`);
  console.log(`[AdverModule] Cached Timestamp: ${cachedTimestamp}`);

  // إذا كانت التواريخ متطابقة وهناك صور محفوظة، استخدم النسخة المحفوظة (بعد التحقق من الخادم)
  if (!forceRefresh &amp;&amp; serverTimestamp &amp;&amp; serverTimestamp === cachedTimestamp &amp;&amp; cachedImages &amp;&amp; cachedImages.length > 0) {
    console.log('%c[AdverModule] Loading ads from cache.', 'color: green; font-weight: bold;');
    localStorage.setItem(CACHE_KEY_LAST_CHECK, Date.now()); // ✅ جديد: تحديث وقت آخر فحص
    buildSlider(container, cachedImages);
    return; // توقف هنا، لا حاجة لجلب الصور من الشبكة
  }

  // --- إذا لم تتطابق التواريخ أو لا توجد نسخة محفوظة، قم بالجلب من الشبكة ---
  console.log('%c[AdverModule] Cache is outdated or empty. Fetching from network...', 'color: orange; font-weight: bold;');

  const R2_PUBLIC_URL = 'https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev';
  const MAX_ADS = 10; // أقصى عدد من الإعلانات للبحث عنه
  const fetchedImages = [];

  /**
   * @description دالة مساعدة للتحقق مما إذا كانت الصورة موجودة عن طريق محاولة تحميلها.
   * @function checkImage
   * @param {string} url - عنوان URL للصورة للتحقق منها.
   * @returns {Promise&lt;{exists: boolean, url: string}>} - وعد (Promise) يُرجع كائنًا يوضح ما إذا كانت الصورة موجودة أم لا، بالإضافة إلى عنوان URL.
   */
  function checkImage(url) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => resolve({ exists: true, url: url });
      img.onerror = () => resolve({ exists: false, url: url });
      img.src = url;
    });
  }

  // جلب الصور الموجودة بالتوازي لتحسين الأداء
  const imageChecks = [];
  for (let i = 1; i &lt;= MAX_ADS; i++) {
    const imageUrl = `${R2_PUBLIC_URL}/pic${i}.webp`;
    imageChecks.push(checkImage(imageUrl));
  }

  const results = await Promise.all(imageChecks);
  results.forEach(result => {
    if (result.exists) fetchedImages.push(result.url);
  });

  // ✅ جديد: حفظ الصور الجديدة وتاريخ التحديث في localStorage
  console.log(`[AdverModule] Fetched ${fetchedImages.length} images. Caching results.`);
  localStorage.setItem(CACHE_KEY_IMAGES, JSON.stringify(fetchedImages));
  if (serverTimestamp) {
    localStorage.setItem(CACHE_KEY_TIMESTAMP, serverTimestamp);
  }
  localStorage.setItem(CACHE_KEY_LAST_CHECK, Date.now()); // ✅ جديد: تحديث وقت آخر فحص بعد جلب الصور

  buildSlider(container, fetchedImages);
}

/**
 * @description يبني ويعرض شريط تمرير (Slider) للصور الإعلانية داخل حاوية محددة.
 *   ينشئ الشرائح والنقاط وأزرار التنقل، ويدير الحركة التلقائية والتفاعلات اليدوية.
 * @function buildSlider
 * @param {HTMLElement} container - عنصر DOM الذي سيحتوي على شريط التمرير.
 * @param {string[]} adImages - مصفوفة من عناوين URL لصور الإعلانات.
 * @returns {void}
 * @see goToSlide
 * @see startAutoPlay
 * @see pauseAutoPlay
 * @see resetAutoPlay
 */
function buildSlider(container, adImages) {
  // إذا لم توجد صور، اعرض رسالة
  if (adImages.length === 0) {
    container.innerHTML = '&lt;p class="no-ads-message">لا توجد إعلانات حالياً&lt;/p>';
    container.style.height = 'auto'; // ضبط الارتفاع
    return;
  }

  // بناء هيكل الشريط الإعلاني
  container.innerHTML = `
    &lt;div class="ad-slider-track">&lt;/div>
    &lt;div class="ad-slider-dots">&lt;/div>
    &lt;!-- ✅ جديد: أزرار التنقل -->
    &lt;button class="ad-slider-nav prev" aria-label="Previous Slide">&lt;i class="fas fa-chevron-left">&lt;/i>&lt;/button>
    &lt;button class="ad-slider-nav next" aria-label="Next Slide">&lt;i class="fas fa-chevron-right">&lt;/i>&lt;/button>
  `;

  const track = container.querySelector('.ad-slider-track');
  const dotsContainer = container.querySelector('.ad-slider-dots');
  const slides = [];
  const dots = [];
  let currentIndex = 0;
  let autoPlayInterval = null; // ✅ جديد: متغير لتخزين مؤقت الحركة التلقائية

  const prevButton = container.querySelector('.ad-slider-nav.prev');
  const nextButton = container.querySelector('.ad-slider-nav.next');

  // إنشاء الشرائح والنقاط
  adImages.forEach((imageUrl, index) => {
    const slide = document.createElement('div');
    slide.className = 'ad-slide';
    slide.style.backgroundImage = `url(${imageUrl})`;
    track.appendChild(slide);

    // ✅ جديد: إضافة أحداث لإيقاف الحركة مؤقتًا عند الضغط المستمر
    slide.addEventListener('mousedown', pauseAutoPlay);
    slide.addEventListener('mouseup', startAutoPlay);
    slide.addEventListener('touchstart', pauseAutoPlay, { passive: true });
    slide.addEventListener('touchend', startAutoPlay);
    slides.push(slide);

    const dot = document.createElement('div');
    dot.className = 'ad-slider-dot';
    dot.addEventListener('click', () => goToSlide(index));
    dotsContainer.appendChild(dot);
    dots.push(dot);
  });

  /**
   * @description تنتقل إلى شريحة محددة وتطبق تأثير الكاروسيل الدائري.
   *   تقوم بحساب وتطبيق التحويلات (transform) لكل شريحة بناءً على موقعها الحالي.
   * @function goToSlide
   * @param {number} index - فهرس الشريحة المستهدفة.
   * @returns {void}
   */
  function goToSlide(index) {
    const newIndex = (index + slides.length) % slides.length;
    currentIndex = newIndex;

    slides.forEach((slide, i) => {
      // ✅ تعديل: حساب الإزاحة بطريقة تأخذ "المسار الأقصر" في الاعتبار
      // هذا يضمن أن الحركة دائرية ومتناظرة دائمًا.
      const totalSlides = slides.length;
      const directOffset = i - currentIndex;
      const wrapOffset = directOffset > 0 ? directOffset - totalSlides : directOffset + totalSlides;
      const offset = Math.abs(directOffset) &lt; Math.abs(wrapOffset) ? directOffset : wrapOffset;

      const isActive = offset === 0;

      // حساب التحريك الأفقي والتكبير
      // الشرائح الجانبية تكون أصغر ومزاحة
      const translateX = offset * 40; // 40% من عرض الشريحة
      const scale = isActive ? 1 : 0.7;
      // ✅ جديد: إضافة إزاحة بسيطة على المحور Z لإعطاء عمق ومنع التداخل
      const translateZ = -Math.abs(offset) * 50;

      slide.style.transform = `translateX(${translateX}%) translateZ(${translateZ}px) scale(${scale})`;
      slide.classList.toggle('active', isActive);

      // عند النقر على شريحة جانبية، تنتقل لتصبح هي النشطة
      slide.onclick = () => goToSlide(i);
    });

    dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
    if (slides.length > 1) {
      resetAutoPlay();
    }
  }

  /**
   * @description تبدأ الحركة التلقائية لشريط التمرير، حيث تنتقل الشرائح كل 4 ثوانٍ.
   * @function startAutoPlay
   * @returns {void}
   */
  function startAutoPlay() {
    if (autoPlayInterval) clearInterval(autoPlayInterval); // مسح المؤقت القديم
    // تغيير الشريحة كل 4 ثوانٍ
    autoPlayInterval = setInterval(() => goToSlide(currentIndex + 1), 4000);
  }

  /**
   * @description توقف الحركة التلقائية لشريط التمرير عن طريق مسح المؤقت.
   * @function pauseAutoPlay
   * @returns {void}
   */
  function pauseAutoPlay() {
    clearInterval(autoPlayInterval);
  }

  /**
   * @description تعيد ضبط الحركة التلقائية لشريط التمرير عن طريق إيقافها ثم إعادة تشغيلها.
   * @function resetAutoPlay
   * @returns {void}
   * @see pauseAutoPlay
   * @see startAutoPlay
   */
  function resetAutoPlay() {
    pauseAutoPlay();
    startAutoPlay();
  }

  // بدء الحركة
  if (slides.length > 0) {
    goToSlide(0); // عرض الشريحة الأولى

    // ✅ جديد: إظهار/إخفاء أزرار التنقل والتحكم في الحركة
    if (slides.length > 1) {
      startAutoPlay();
      prevButton.style.display = 'flex';
      nextButton.style.display = 'flex';

      prevButton.addEventListener('click', () => {
        goToSlide(currentIndex - 1);
      });

      nextButton.addEventListener('click', () => {
        goToSlide(currentIndex + 1);
      });
    } else {
      prevButton.style.display = 'none';
      nextButton.style.display = 'none';
      // ✅ جديد: إخفاء حاوية النقاط إذا كانت هناك صورة واحدة فقط
      dotsContainer.style.display = 'none';
    }
  }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#CONNECTION_CHECK_INTERVAL">CONNECTION_CHECK_INTERVAL</a></li><li><a href="global.html#DB_NAME">DB_NAME</a></li><li><a href="global.html#DB_VERSION">DB_VERSION</a></li><li><a href="global.html#NOTIFICATIONS_STORE">NOTIFICATIONS_STORE</a></li><li><a href="global.html#ORDER_STATUSES">ORDER_STATUSES</a></li><li><a href="global.html#ORDER_STATUS_MAP">ORDER_STATUS_MAP</a></li><li><a href="global.html#SERVICE_CATEGORY_NoPrice_ID">SERVICE_CATEGORY_NoPrice_ID</a></li><li><a href="global.html#addNotificationLog">addNotificationLog</a></li><li><a href="global.html#addProduct">addProduct</a></li><li><a href="global.html#addRecord">addRecord</a></li><li><a href="global.html#addToCart">addToCart</a></li><li><a href="global.html#addUpdate">addUpdate</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#adminPhoneNumbers">adminPhoneNumbers</a></li><li><a href="global.html#apiFetch">apiFetch</a></li><li><a href="global.html#applyFilters">applyFilters</a></li><li><a href="global.html#askForNotificationPermission">askForNotificationPermission</a></li><li><a href="global.html#baseURL">baseURL</a></li><li><a href="global.html#buildSlider">buildSlider</a></li><li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li><li><a href="global.html#checkAndDisplayNotificationStatus">checkAndDisplayNotificationStatus</a></li><li><a href="global.html#checkImage">checkImage</a></li><li><a href="global.html#checkInternetConnection">checkInternetConnection</a></li><li><a href="global.html#checkLoginStatus">checkLoginStatus</a></li><li><a href="global.html#clearCart">clearCart</a></li><li><a href="global.html#clearError">clearError</a></li><li><a href="global.html#clearNotificationLogs">clearNotificationLogs</a></li><li><a href="global.html#createOrder">createOrder</a></li><li><a href="global.html#createStatusTimelineHTML">createStatusTimelineHTML</a></li><li><a href="global.html#dbPromise">dbPromise</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#deleteProduct">deleteProduct</a></li><li><a href="global.html#deleteProductAndImages">deleteProductAndImages</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#displayUsers">displayUsers</a></li><li><a href="global.html#fetchUsers">fetchUsers</a></li><li><a href="global.html#filterMyProducts">filterMyProducts</a></li><li><a href="global.html#generateCartItemHTML">generateCartItemHTML</a></li><li><a href="global.html#generateNotificationLogItemHTML">generateNotificationLogItemHTML</a></li><li><a href="global.html#generateOrderKey">generateOrderKey</a></li><li><a href="global.html#generateProductCardHTML">generateProductCardHTML</a></li><li><a href="global.html#generatePurchaseItemHTML">generatePurchaseItemHTML</a></li><li><a href="global.html#generateSalesMovementItemHTML">generateSalesMovementItemHTML</a></li><li><a href="global.html#generateUserCardHTML">generateUserCardHTML</a></li><li><a href="global.html#getCart">getCart</a></li><li><a href="global.html#getCartItemCount">getCartItemCount</a></li><li><a href="global.html#getCartStorageKey">getCartStorageKey</a></li><li><a href="global.html#getCurrentUser">getCurrentUser</a></li><li><a href="global.html#getLatestUpdate">getLatestUpdate</a></li><li><a href="global.html#getNotificationLogs">getNotificationLogs</a></li><li><a href="global.html#getNotificationTokensForOrder">getNotificationTokensForOrder</a></li><li><a href="global.html#getProductByKey">getProductByKey</a></li><li><a href="global.html#getProductsByCategory">getProductsByCategory</a></li><li><a href="global.html#getProductsByUser">getProductsByUser</a></li><li><a href="global.html#getSalesMovement">getSalesMovement</a></li><li><a href="global.html#getUniqueSellerKeys">getUniqueSellerKeys</a></li><li><a href="global.html#getUserByPhone">getUserByPhone</a></li><li><a href="global.html#getUserPurchases">getUserPurchases</a></li><li><a href="global.html#goToSlide">goToSlide</a></li><li><a href="global.html#handleAccountDeletion">handleAccountDeletion</a></li><li><a href="global.html#handleCheckout">handleCheckout</a></li><li><a href="global.html#handleGuestLogin">handleGuestLogin</a></li><li><a href="global.html#handleLoginSuccess">handleLoginSuccess</a></li><li><a href="global.html#handleNewNotification">handleNewNotification</a></li><li><a href="global.html#handleRevokedPermissions">handleRevokedPermissions</a></li><li><a href="global.html#hideText">hideText</a></li><li><a href="global.html#initAdverModule">initAdverModule</a></li><li><a href="global.html#initDB">initDB</a></li><li><a href="global.html#initSearchModal">initSearchModal</a></li><li><a href="global.html#initializeAdminPanel">initializeAdminPanel</a></li><li><a href="global.html#initializeNotifications">initializeNotifications</a></li><li><a href="global.html#initializeUsersAdminLogic">initializeUsersAdminLogic</a></li><li><a href="global.html#isConnectedCache">isConnectedCache</a></li><li><a href="global.html#isUserAdmin">isUserAdmin</a></li><li><a href="global.html#isUserEligibleForNotifications">isUserEligibleForNotifications</a></li><li><a href="global.html#isUserSeller">isUserSeller</a></li><li><a href="global.html#lastConnectionCheck">lastConnectionCheck</a></li><li><a href="global.html#loadAndShowModal">loadAndShowModal</a></li><li><a href="global.html#loadCategories">loadCategories</a></li><li><a href="global.html#loadCategoryFilters">loadCategoryFilters</a></li><li><a href="global.html#loadPageContent">loadPageContent</a></li><li><a href="global.html#loadUsersTable">loadUsersTable</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#normalizeArabicText">normalizeArabicText</a></li><li><a href="global.html#normalizeDigits">normalizeDigits</a></li><li><a href="global.html#offlineToast">offlineToast</a></li><li><a href="global.html#pauseAutoPlay">pauseAutoPlay</a></li><li><a href="global.html#performActualConnectionCheck">performActualConnectionCheck</a></li><li><a href="global.html#performSearch">performSearch</a></li><li><a href="global.html#populateProductDetails">populateProductDetails</a></li><li><a href="global.html#removeFromCart">removeFromCart</a></li><li><a href="global.html#resetAutoPlay">resetAutoPlay</a></li><li><a href="global.html#saveCart">saveCart</a></li><li><a href="global.html#saveNotificationFromAndroid">saveNotificationFromAndroid</a></li><li><a href="global.html#sendNotification">sendNotification</a></li><li><a href="global.html#sendTokenToServer">sendTokenToServer</a></li><li><a href="global.html#setupFCM">setupFCM</a></li><li><a href="global.html#setupModalLogic">setupModalLogic</a></li><li><a href="global.html#showAddProductModal">showAddProductModal</a></li><li><a href="global.html#showAdvertiesmentModal">showAdvertiesmentModal</a></li><li><a href="global.html#showCartModal">showCartModal</a></li><li><a href="global.html#showEditProductModal">showEditProductModal</a></li><li><a href="global.html#showEditProfileModal">showEditProfileModal</a></li><li><a href="global.html#showError">showError</a></li><li><a href="global.html#showFinalText">showFinalText</a></li><li><a href="global.html#showMyProducts">showMyProducts</a></li><li><a href="global.html#showNotificationsLogModal">showNotificationsLogModal</a></li><li><a href="global.html#showNotificationsModal">showNotificationsModal</a></li><li><a href="global.html#showProductDetails">showProductDetails</a></li><li><a href="global.html#showPurchasesModal">showPurchasesModal</a></li><li><a href="global.html#showSalesMovementModal">showSalesMovementModal</a></li><li><a href="global.html#showTextWithZoom">showTextWithZoom</a></li><li><a href="global.html#showUsersAdminModal">showUsersAdminModal</a></li><li><a href="global.html#startAnimationCycle">startAnimationCycle</a></li><li><a href="global.html#startAutoPlay">startAutoPlay</a></li><li><a href="global.html#startPeriodicConnectionCheck">startPeriodicConnectionCheck</a></li><li><a href="global.html#startTaglineCarousel">startTaglineCarousel</a></li><li><a href="global.html#updateCartBadge">updateCartBadge</a></li><li><a href="global.html#updateCartQuantity">updateCartQuantity</a></li><li><a href="global.html#updateOrderStatus">updateOrderStatus</a></li><li><a href="global.html#updateProduct">updateProduct</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#updateUsers">updateUsers</a></li><li><a href="global.html#updateViewForLoggedInUser">updateViewForLoggedInUser</a></li><li><a href="global.html#verifyUserPassword">verifyUserPassword</a></li><li><a href="global.html#waitForFcmKey">waitForFcmKey</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Nov 22 2025 02:55:09 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
