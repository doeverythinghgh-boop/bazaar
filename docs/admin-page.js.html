<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: admin-page.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: admin-page.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file js/admin-page.js
 * @description يحتوي هذا الملف على كل المنطق البرمجي الخاص بصفحة admin.html.
 *
 * يشمل ذلك:
 * - التحقق من صلاحيات المسؤول.
 * - عرض لوحة تحكم المسؤول (Admin) لإدارة المستخدمين.
 * - توفير وظيفة مسح بيانات المتصفح.
 */

document.addEventListener("DOMContentLoaded", () => {
  const loggedInUser = localStorage.getItem("loggedInUser");
  // adminPhoneNumbers معرفة بشكل عام في js/config.js
  const loadingContainer = document.getElementById("loading-container");
  const adminPanelContainer = document.getElementById("admin-panel-container");

  if (!loggedInUser) {
    // إذا لم يكن المستخدم مسجلاً دخوله، أعد توجيهه إلى صفحة تسجيل الدخول
    window.location.href = "login.html";
    return;
  }

  const user = JSON.parse(loggedInUser);

  if (!adminPhoneNumbers.includes(user.phone)) {
    // إذا لم يكن المستخدم مسؤولاً، اعرض رسالة "وصول مرفوض"
    loadingContainer.innerHTML = `
      &lt;div class="login-container" style="text-align: center; color: #e74c3c;">
        &lt;h2>&lt;i class="fas fa-exclamation-triangle">&lt;/i> وصول مرفوض&lt;/h2>
        &lt;p>هذه الصفحة مخصصة للمسؤولين فقط.&lt;/p>
        &lt;a href="index.html" class="button" style="margin-top: 20px;">العودة إلى الرئيسية&lt;/a>
      &lt;/div>
    `;
    return;
  }

  // إذا كان المستخدم مسؤولاً، قم بإعداد لوحة التحكم
  loadingContainer.style.display = "none";
  adminPanelContainer.style.display = "flex";
  initializeAdminPanel(user);
});

/**
 * @description تهيئة لوحة تحكم المسؤول، بما في ذلك عرض رسالة الترحيب، والتحقق من حالة الإشعارات،
 *   وإنشاء الأزرار الخاصة بإدارة الإعلانات، عرض المستخدمين، ومسح بيانات المتصفح، ثم ربط الأحداث بها.
 * @function initializeAdminPanel
 * @param {object} user - كائن المستخدم الحالي (المسؤول) الذي تم تسجيل دخوله.
 * @returns {void}
 * @see checkAndDisplayNotificationStatus
 * @see showAdvertiesmentModal
 * @see showUsersAdminModal
 */
function initializeAdminPanel(user) {
  document.getElementById("welcome-message").textContent = `لوحة تحكم المسؤول | ${user.username}`;
  // جديد: التحقق من حالة الإشعارات وعرضها
  checkAndDisplayNotificationStatus();

  // --- إنشاء الأزرار ووضعها في مجموعاتها المخصصة ---

  // 1. زر "إدارة الإعلانات"
  const manageAdButton = document.createElement("button");
  manageAdButton.id = "manage-ad-btn";
  manageAdButton.className = "button logout-btn-small";
  manageAdButton.innerHTML = '&lt;i class="fas fa-ad">&lt;/i> إدارة الإعلانات';
  manageAdButton.addEventListener('click', showAdvertiesmentModal);
  document.getElementById("content-management-row").appendChild(manageAdButton);

  // 2. زر "عرض المستخدمين"
  const viewUsersButton = document.createElement("a");
  viewUsersButton.id = "view-users-btn";
  viewUsersButton.href = "#";
  viewUsersButton.className = "button logout-btn-small";
  viewUsersButton.innerHTML = '&lt;i class="fas fa-users">&lt;/i> عرض المستخدمين';
  viewUsersButton.addEventListener("click", (e) => {
    e.preventDefault();
    showUsersAdminModal(); // استدعاء دالة الموديول الجديد
  });
  document.getElementById("users-management-row").appendChild(viewUsersButton);

  // 3. زر "مسح بيانات المتصفح"
  const clearBrowserDataButton = document.createElement("a");
  clearBrowserDataButton.id = "clear-data-btn";
  clearBrowserDataButton.href = "#";
  clearBrowserDataButton.className = "button logout-btn-small";
  clearBrowserDataButton.style.backgroundColor = "#c0392b";
  clearBrowserDataButton.innerHTML = '&lt;i class="fas fa-broom">&lt;/i> مسح بيانات المتصفح';
  document.getElementById("settings-row").appendChild(clearBrowserDataButton);

  // --- ربط الأحداث بالأزرار ---

  // منطق زر "مسح بيانات المتصفح"
  clearBrowserDataButton.addEventListener("click", (e) => {
    e.preventDefault();
    Swal.fire({
      title: 'هل أنت متأكد تمامًا؟',
      text: "سيتم مسح جميع بيانات الموقع من هذا المتصفح (localStorage, sessionStorage) وتسجيل خروجك. هذا الإجراء لا يمكن التراجع عنه!",
      icon: 'error',
      showCancelButton: true,
      confirmButtonColor: '#e74c3c',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'نعم، امسح كل شيء!',
      cancelButtonText: 'إلغاء',
      showLoaderOnConfirm: true,
      preConfirm: async () => {
        try {
          localStorage.clear();
          sessionStorage.clear();
          if ('serviceWorker' in navigator) {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
            }
          }
          if ('caches' in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(key => caches.delete(key)));
          }
          const cookies = document.cookie.split(";");
          for (let i = 0; i &lt; cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
          }
        } catch (error) {
          Swal.showValidationMessage(`فشل إعادة التعيين: ${error}`);
        }
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({
          title: 'اكتمل المسح الشامل!',
          icon: 'success',
          html: `
            &lt;div style="text-align: right; line-height: 1.6;">
              تم مسح جميع بيانات الموقع بنجاح.
              &lt;br>&lt;br>
              &lt;strong>لإزالة الأذونات (مثل الإشعارات) بشكل كامل:&lt;/strong>
              &lt;ol style="padding-right: 20px; margin-top: 10px; text-align: right;">
                &lt;li>انقر على أيقونة القفل &lt;i class="fas fa-lock" style="color: #555;">&lt;/i> بجوار عنوان الموقع.&lt;/li>
                &lt;li>اختر "إعدادات الموقع" ثم "إعادة ضبط الأذونات".&lt;/li>
              &lt;/ol>
              &lt;br>
              سيتم إعادة تحميل الصفحة.
            &lt;/div>`,
          confirmButtonText: 'موافق'
        }).then(() => {
          window.location.reload(true);
        });
      }
    });
  });
}

/**
 * @description يعرض نافذة منبثقة (Modal) لإدارة الإعلانات، ويقوم بتحميل محتواها من `pages/Advertiesment.html`.
 *   بعد تحميل المحتوى، يستدعي دالة `initializeAdvertiesmentForm` لتهيئة النموذج.
 * @function showAdvertiesmentModal
 * @returns {Promise&lt;void>} - وعد (Promise) لا يُرجع قيمة عند الاكتمال.
 * @see loadAndShowModal
 * @see initializeAdvertiesmentForm
 */
async function showAdvertiesmentModal() {
  await loadAndShowModal(
    "adver-modal",
    "pages/Advertiesment.html",
    (modal) => {
      if (typeof initializeAdvertiesmentForm === "function") {
        initializeAdvertiesmentForm(modal);
      }
    }
  );
}

/**
 * @description يتحقق من حالة إذن الإشعارات ووجود توكن FCM، ثم يعرض رسالة وزر تفعيل أو معلومات الحالة بناءً على ذلك.
 *   يوفر للمستخدمين واجهة للتفاعل مع أذونات الإشعارات.
 * @function checkAndDisplayNotificationStatus
 * @returns {Promise&lt;void>} - وعد (Promise) لا يُرجع قيمة عند الاكتمال.
 * @see setupFCM
 */
async function checkAndDisplayNotificationStatus() {
  const statusContainer = document.getElementById('notification-status-container');
  if (!statusContainer) return;

  // ✅ جديد: التحقق أولاً مما إذا كان المتصفح يدعم الإشعارات من الأساس
  if (!('Notification' in window) || !('serviceWorker' in navigator)) {
    statusContainer.innerHTML = `&lt;i class="fas fa-exclamation-circle" style="color: #ffc107;">&lt;/i> &lt;span>حالة الإشعارات: &lt;strong>غير مدعومة&lt;/strong> (هذا المتصفح لا يدعم استقبال الإشعارات)&lt;/span>`;
    return;
  }

  let statusHTML = '';
  const permission = Notification.permission;
  const fcmToken = localStorage.getItem('fcm_token');

  if (permission === 'granted') {
    if (fcmToken) {
      statusHTML = `&lt;i class="fas fa-check-circle" style="color: #28a745;">&lt;/i> &lt;span>حالة الإشعارات: &lt;strong>مفعّلة&lt;/strong> (أنت تستقبل الإشعارات حاليًا)&lt;/span>`;
    } else {
      statusHTML = `&lt;i class="fas fa-exclamation-triangle" style="color: #ffc107;">&lt;/i> &lt;span>حالة الإشعارات: &lt;strong>قيد التفعيل.&lt;/strong> (حاول إعادة تحميل الصفحة لتسجيل الجهاز)&lt;/span> &lt;button id="request-notif-btn" class="button-small-action">إعادة المحاولة&lt;/button>`;
    }
  } else if (permission === 'denied') {
    statusHTML = `&lt;i class="fas fa-times-circle" style="color: #dc3545;">&lt;/i> &lt;span>حالة الإشعارات: &lt;strong>معطّلة&lt;/strong> (لقد قمت برفض الإذن)&lt;/span> &lt;button id="request-notif-btn" class="button-small-action">إعادة التفعيل&lt;/button>`;
  } else {
    statusHTML = `&lt;i class="fas fa-question-circle" style="color: #6c757d;">&lt;/i> &lt;span>حالة الإشعارات: &lt;strong>غير محددة&lt;/strong>&lt;/span> &lt;button id="request-notif-btn" class="button-small-action">تفعيل الإشعارات&lt;/button>`;
  }

  statusContainer.innerHTML = statusHTML;

  // إضافة وظيفة للزر الجديد
  const requestBtn = document.getElementById('request-notif-btn');
  if (requestBtn) {
    requestBtn.addEventListener('click', async () => {
      // إذا كان الإذن مرفوضًا، يجب على المستخدم تغييره يدويًا
      if (Notification.permission === 'denied') {
        Swal.fire({
          title: 'الإشعارات محظورة',
          icon: 'info',
          html: `
            &lt;div style="text-align: right; line-height: 1.7;">
              لقد قمت بحظر الإشعارات لهذا الموقع سابقًا. لإعادة تفعيلها، اتبع الخطوات الخاصة بمتصفحك:
              &lt;ul style="padding-right: 20px; margin-top: 15px; text-align: right; list-style-type: none;">
                &lt;li style="margin-bottom: 10px;">&lt;strong>&lt;i class="fas fa-desktop" style="color: #555;">&lt;/i> على الكمبيوتر أو أندرويد:&lt;/strong>&lt;br>
                  انقر على أيقونة القفل &lt;i class="fas fa-lock" style="color: #555;">&lt;/i> بجوار عنوان الموقع، ثم اختر "الأذونات" أو "إعدادات الموقع" وقم بتغيير "الإشعارات" إلى "سماح".
                &lt;/li>
                &lt;li>&lt;strong>&lt;i class="fas fa-mobile-alt" style="color: #555;">&lt;/i> على أجهزة أخرى:&lt;/strong>&lt;br>
                  اذهب إلى إعدادات المتصفح، ثم "إعدادات المواقع"، وابحث عن موقعنا لتعديل أذونات الإشعارات.&lt;/li>
              &lt;/ul>
              &lt;p style="margin-top: 15px;">قد تحتاج إلى إعادة تحميل الصفحة بعد تغيير الإعداد.&lt;/p>
            &lt;/div>`,
          confirmButtonText: 'حسنًا، فهمت'
        });
        return;
      }

      // إذا لم يكن الإذن ممنوحًا، اطلب الإذن
      if (typeof setupFCM === 'function') {
        requestBtn.disabled = true;
        requestBtn.textContent = 'جاري...';
        try {
          await setupFCM(); // استدعاء دالة طلب الإذن من auth.js
          // إعادة التحقق من الحالة بعد محاولة التفعيل
          await checkAndDisplayNotificationStatus();
        } catch (error) {
          console.error("فشل في إعداد FCM:", error);
          Swal.fire('خطأ', 'حدث خطأ أثناء محاولة تفعيل الإشعارات.', 'error');
          requestBtn.disabled = false;
          requestBtn.textContent = 'إعادة المحاولة';
        }
      } else {
        console.error('الدالة setupFCM غير موجودة.');
        Swal.fire('خطأ فني', 'لا يمكن طلب إذن الإشعارات حاليًا.', 'error');
      }
    });
  }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#CONNECTION_CHECK_INTERVAL">CONNECTION_CHECK_INTERVAL</a></li><li><a href="global.html#DB_NAME">DB_NAME</a></li><li><a href="global.html#DB_VERSION">DB_VERSION</a></li><li><a href="global.html#NOTIFICATIONS_STORE">NOTIFICATIONS_STORE</a></li><li><a href="global.html#ORDER_STATUSES">ORDER_STATUSES</a></li><li><a href="global.html#ORDER_STATUS_MAP">ORDER_STATUS_MAP</a></li><li><a href="global.html#SERVICE_CATEGORY_NoPrice_ID">SERVICE_CATEGORY_NoPrice_ID</a></li><li><a href="global.html#addNotificationLog">addNotificationLog</a></li><li><a href="global.html#addProduct">addProduct</a></li><li><a href="global.html#addRecord">addRecord</a></li><li><a href="global.html#addToCart">addToCart</a></li><li><a href="global.html#addUpdate">addUpdate</a></li><li><a href="global.html#addUser">addUser</a></li><li><a href="global.html#adminPhoneNumbers">adminPhoneNumbers</a></li><li><a href="global.html#apiFetch">apiFetch</a></li><li><a href="global.html#applyFilters">applyFilters</a></li><li><a href="global.html#askForNotificationPermission">askForNotificationPermission</a></li><li><a href="global.html#baseURL">baseURL</a></li><li><a href="global.html#buildSlider">buildSlider</a></li><li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li><li><a href="global.html#checkAndDisplayNotificationStatus">checkAndDisplayNotificationStatus</a></li><li><a href="global.html#checkImage">checkImage</a></li><li><a href="global.html#checkInternetConnection">checkInternetConnection</a></li><li><a href="global.html#checkLoginStatus">checkLoginStatus</a></li><li><a href="global.html#clearCart">clearCart</a></li><li><a href="global.html#clearError">clearError</a></li><li><a href="global.html#clearNotificationLogs">clearNotificationLogs</a></li><li><a href="global.html#createOrder">createOrder</a></li><li><a href="global.html#createStatusTimelineHTML">createStatusTimelineHTML</a></li><li><a href="global.html#dbPromise">dbPromise</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#deleteProduct">deleteProduct</a></li><li><a href="global.html#deleteProductAndImages">deleteProductAndImages</a></li><li><a href="global.html#deleteUser">deleteUser</a></li><li><a href="global.html#displaySearchResults">displaySearchResults</a></li><li><a href="global.html#displayUsers">displayUsers</a></li><li><a href="global.html#fetchUsers">fetchUsers</a></li><li><a href="global.html#filterMyProducts">filterMyProducts</a></li><li><a href="global.html#generateCartItemHTML">generateCartItemHTML</a></li><li><a href="global.html#generateNotificationLogItemHTML">generateNotificationLogItemHTML</a></li><li><a href="global.html#generateOrderKey">generateOrderKey</a></li><li><a href="global.html#generateProductCardHTML">generateProductCardHTML</a></li><li><a href="global.html#generatePurchaseItemHTML">generatePurchaseItemHTML</a></li><li><a href="global.html#generateSalesMovementItemHTML">generateSalesMovementItemHTML</a></li><li><a href="global.html#generateUserCardHTML">generateUserCardHTML</a></li><li><a href="global.html#getCart">getCart</a></li><li><a href="global.html#getCartItemCount">getCartItemCount</a></li><li><a href="global.html#getCartStorageKey">getCartStorageKey</a></li><li><a href="global.html#getCurrentUser">getCurrentUser</a></li><li><a href="global.html#getLatestUpdate">getLatestUpdate</a></li><li><a href="global.html#getNotificationLogs">getNotificationLogs</a></li><li><a href="global.html#getNotificationTokensForOrder">getNotificationTokensForOrder</a></li><li><a href="global.html#getProductByKey">getProductByKey</a></li><li><a href="global.html#getProductsByCategory">getProductsByCategory</a></li><li><a href="global.html#getProductsByUser">getProductsByUser</a></li><li><a href="global.html#getSalesMovement">getSalesMovement</a></li><li><a href="global.html#getUniqueSellerKeys">getUniqueSellerKeys</a></li><li><a href="global.html#getUserByPhone">getUserByPhone</a></li><li><a href="global.html#getUserPurchases">getUserPurchases</a></li><li><a href="global.html#goToSlide">goToSlide</a></li><li><a href="global.html#handleAccountDeletion">handleAccountDeletion</a></li><li><a href="global.html#handleCheckout">handleCheckout</a></li><li><a href="global.html#handleGuestLogin">handleGuestLogin</a></li><li><a href="global.html#handleLoginSuccess">handleLoginSuccess</a></li><li><a href="global.html#handleNewNotification">handleNewNotification</a></li><li><a href="global.html#handleRevokedPermissions">handleRevokedPermissions</a></li><li><a href="global.html#hideText">hideText</a></li><li><a href="global.html#initAdverModule">initAdverModule</a></li><li><a href="global.html#initDB">initDB</a></li><li><a href="global.html#initSearchModal">initSearchModal</a></li><li><a href="global.html#initializeAdminPanel">initializeAdminPanel</a></li><li><a href="global.html#initializeNotifications">initializeNotifications</a></li><li><a href="global.html#initializeUsersAdminLogic">initializeUsersAdminLogic</a></li><li><a href="global.html#isConnectedCache">isConnectedCache</a></li><li><a href="global.html#isUserAdmin">isUserAdmin</a></li><li><a href="global.html#isUserEligibleForNotifications">isUserEligibleForNotifications</a></li><li><a href="global.html#isUserSeller">isUserSeller</a></li><li><a href="global.html#lastConnectionCheck">lastConnectionCheck</a></li><li><a href="global.html#loadAndShowModal">loadAndShowModal</a></li><li><a href="global.html#loadCategories">loadCategories</a></li><li><a href="global.html#loadCategoryFilters">loadCategoryFilters</a></li><li><a href="global.html#loadPageContent">loadPageContent</a></li><li><a href="global.html#loadUsersTable">loadUsersTable</a></li><li><a href="global.html#logout">logout</a></li><li><a href="global.html#normalizeArabicText">normalizeArabicText</a></li><li><a href="global.html#normalizeDigits">normalizeDigits</a></li><li><a href="global.html#offlineToast">offlineToast</a></li><li><a href="global.html#pauseAutoPlay">pauseAutoPlay</a></li><li><a href="global.html#performActualConnectionCheck">performActualConnectionCheck</a></li><li><a href="global.html#performSearch">performSearch</a></li><li><a href="global.html#populateProductDetails">populateProductDetails</a></li><li><a href="global.html#removeFromCart">removeFromCart</a></li><li><a href="global.html#resetAutoPlay">resetAutoPlay</a></li><li><a href="global.html#saveCart">saveCart</a></li><li><a href="global.html#saveNotificationFromAndroid">saveNotificationFromAndroid</a></li><li><a href="global.html#sendNotification">sendNotification</a></li><li><a href="global.html#sendTokenToServer">sendTokenToServer</a></li><li><a href="global.html#setupFCM">setupFCM</a></li><li><a href="global.html#setupModalLogic">setupModalLogic</a></li><li><a href="global.html#showAddProductModal">showAddProductModal</a></li><li><a href="global.html#showAdvertiesmentModal">showAdvertiesmentModal</a></li><li><a href="global.html#showCartModal">showCartModal</a></li><li><a href="global.html#showEditProductModal">showEditProductModal</a></li><li><a href="global.html#showEditProfileModal">showEditProfileModal</a></li><li><a href="global.html#showError">showError</a></li><li><a href="global.html#showFinalText">showFinalText</a></li><li><a href="global.html#showMyProducts">showMyProducts</a></li><li><a href="global.html#showNotificationsLogModal">showNotificationsLogModal</a></li><li><a href="global.html#showNotificationsModal">showNotificationsModal</a></li><li><a href="global.html#showProductDetails">showProductDetails</a></li><li><a href="global.html#showPurchasesModal">showPurchasesModal</a></li><li><a href="global.html#showSalesMovementModal">showSalesMovementModal</a></li><li><a href="global.html#showTextWithZoom">showTextWithZoom</a></li><li><a href="global.html#showUsersAdminModal">showUsersAdminModal</a></li><li><a href="global.html#startAnimationCycle">startAnimationCycle</a></li><li><a href="global.html#startAutoPlay">startAutoPlay</a></li><li><a href="global.html#startPeriodicConnectionCheck">startPeriodicConnectionCheck</a></li><li><a href="global.html#startTaglineCarousel">startTaglineCarousel</a></li><li><a href="global.html#updateCartBadge">updateCartBadge</a></li><li><a href="global.html#updateCartQuantity">updateCartQuantity</a></li><li><a href="global.html#updateOrderStatus">updateOrderStatus</a></li><li><a href="global.html#updateProduct">updateProduct</a></li><li><a href="global.html#updateUser">updateUser</a></li><li><a href="global.html#updateUsers">updateUsers</a></li><li><a href="global.html#updateViewForLoggedInUser">updateViewForLoggedInUser</a></li><li><a href="global.html#verifyUserPassword">verifyUserPassword</a></li><li><a href="global.html#waitForFcmKey">waitForFcmKey</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Sat Nov 22 2025 03:46:40 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
