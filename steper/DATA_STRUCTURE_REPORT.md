# بناء وتدفق بيانات Steper (Server Data Structure & Flow)

يصف هذا التقرير كيفية حفظ واسترجاع بيانات نظام الـ Steper من الخادم (Server)، مع تفصيل هيكلية البيانات في جميع السيناريوهات المتوقعة بعد التحديث لنظام "التوافق التام" (Total Consistency).

## 1. مبدأ العمل العام
يعتمد النظام حالياً على مبدأ **"الخادم هو المصدر الوحيد للحقيقة" (Single Source of Truth)**.
- **تم إلغاء** التخزين المحلي (LocalStorage) بالكامل.
- **تم اعتماد** آلية التحديث الانتظاري (Blocking Update): لا تتغير حالة الواجهة إلا بعد استلام رد `200 OK` من السيرفر.

---

## 2. هيكلية حفظ البيانات (Data Structure)

يتم تخزين جميع حالات Steper داخل حقل `order_status` في جدول الطلبات. هذا الحقل عبارة عن نص (String) مركب، مما يسمح بحفظ بيانات معقدة دون الحاجة لتغيير هيكلية قاعدة البيانات (Database Schema).

### صيغة `order_status`
```text
StepID # Timestamp # JSON_Blob
```

| المكون | الوصف | مثال |
| :--- | :--- | :--- |
| **StepID** | معرف آخر مرحلة رئيسية وصل لها الطلب (للرجوع للخلف). | `step-confirmed` |
| **Timestamp** | توقيت آخر تحديث (ISO String). | `2024-12-15T21:00:00.000Z` |
| **JSON_Blob** | كائن مضغوط يحتوي على تفاصيل الحالات والتواريخ. | `{ "item_123": "rejected", "__confirmation_locked__": "locked" ... }` |

### محتويات `JSON_Blob`
يستخدم الـ JSON الداخلي كمخزن مرن (Key-Value Store) يحتوي على ثلاثة أنواع من البيانات:

1.  **حالات المنتجات (Item Statuses):**
    *   **المفتاح user:** `product_key` (مثل `1734057973789`)
    *   **القيمة:** حالة المنتج (`confirmed`, `rejected`, `shipped`, `delivered`, `pending`)
    *   *ملاحظة:* يتم تخزين حالة المنتج أيضاً في جدول `order_items` بشكل منفصل في الباك-إند، ولكن الـ Blob يستخدم للتزامن السريع.

2.  **أقفال النظام (System Locks):**
    *   **المفتاح:** `__confirmation_locked__`
    *   **القيمة:** `locked` أو `unlocked`
    *   *الهدف:* منع البائع من تعديل المنتجات بعد تأكيدها نهائياً.

3.  **تواريخ تفعيل المراحل (Step Activation Dates):**
    *   **المفتاح:** `__date_{step_id}__` (مثل `__date_step-shipped__`)
    *   **القيمة:** التوقيت كنص (e.g., `2024-12-15 09:30 PM`)
    *   *الهدف:* حفظ تاريخ وصول الطلب لكل مرحلة لعرضه في شريط التتبع (Timeline).

---

## 3. سيناريوهات تدفق البيانات (Data Flow Scenarios)

### السيناريو 1: تحميل الصفحة (Initialization)
1.  يقوم المتصفح بطلب `fetchOrdersData`.
2.  يستقبل `ordersData` الذي يحتوي على `order_status`.
3.  دالة `initializeState`:
    *   تقرأ `order_status`.
    *   تفكك النص وتستخرج الـ JSON.
    *   **المنتجات:** تُحدّث حالة كل منتج في الذاكرة.
    *   **التواريخ:** تبحث عن المفاتيح التي تبدأ بـ `__date_` وتُعبئ تواريخ الـ Timeline.
4.  يتم بناء الواجهة بناءً على هذه البيانات الحية.

### السيناريو 2: بائع يحفظ تأكيد الطلب (Confirm Order)
1.  يقوم البائع باختيار منتجات "مقبولة" وأخرى "مرفوضة".
2.  يضغط "حفظ".
3.  **النظام (Client):** يرسل طلبات `POST /api/update-item-status` لكل منتج (Blocking).
    *   مثال: `Key: item_123, Status: confirmed`
    *   مثال: `Key: item_456, Status: rejected`
4.  **النظام (Client):** بعد نجاح حفظ المنتجات، يرسل طلب "قفل":
    *   `Key: __confirmation_locked__, Status: locked`
5.  **السيرفر:** يحدّث الـ JSON Blob بدمج القيم الجديدة.
6.  **الواجهة:** تظهر رسالة "تم الحفظ" وتغلق النافذة.

### السيناريو 3: تفعيل مرحلة جديدة (Step Activation)
*مثال: تفعيل مرحلة "تم الشحن" (Shipped)*
1.  يضغط البائع على "تفعيل المرحلة".
2.  **النظام:** يولد التاريخ الحالي (e.g., `2024-12-16...`).
3.  **النظام:** يرسل `POST` للسيرفر:
    *   `Key: __date_step-shipped__`
    *   `Value: 2024-12-16...`
4.  **السيرفر:** يضيف هذا المفتاح للـ JSON Blob.
5.  **النتيجة:** عند إعادة تحميل الصفحة، سيظهر التاريخ تحت اسم المرحلة في الـ UI.

### السيناريو 4: فشل الاتصال (Error Handling)
1.  يحاول المستخدم تغيير حالة.
2.  النظام يرسل `fetch`.
3.  الإنترنت مفصول -> `fetch` يرمي `Error`.
4.  **الواجهة:** تظهر رسالة خطأ `Swal.fire("فشل الحفظ")`.
5.  **البيانات:** لا تتغير في الذاكرة ولا في الواجهة (تطابق تام مع فشل السيرفر).

---

## 4. ملخص شكل الـ JSON المتوقع في `order_status`

```json
{
  "1734057973789": "confirmed",
  "1734057973790": "rejected",
  "__confirmation_locked__": "locked",
  "__date_step-confirmed__": "2024-12-15 10:00 PM",
  "__date_step-shipped__": "2024-12-16 09:30 AM"
}
```

هذا التصميم يضمن:
1.  **المرونة:** يمكن إضافة أي بيانات مستقبلية (مثل اسم السائق) بنفس الطريقة.
2.  **التوافق:** لا تعارض بين ما يراه المستخدم وما هو محفوظ.
3.  **الأمان:** لا يمكن التلاعب بالبيانات عبر أدوات المتصفح (Console) للتأثير المستقبلي، لأن المصدر هو السيرفر دائماً.
