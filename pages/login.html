<style>
  /* Note: Hover effects are not allowed in this project. */

  /* === New and Improved Login Page Design === */

  /* 1. Page Background and General Layout */
  @keyframes login_gradient-animation {
    0% {
      background-position: 0% 50%;
    }

    50% {
      background-position: 100% 50%;
    }

    100% {
      background-position: 0% 50%;
    }
  }

  .login_page-wrapper {
    font-family: "Tajawal", sans-serif;
    /* NEW: Attractive animated background */
    background-size: 400% 400%;
    animation: login_gradient-animation 15s ease infinite;
    min-height: 100vh;
    display: flex;
    /* âœ… Fix: Change vertical alignment method */
    align-items: flex-start;
    /* Align content to the top */
    justify-content: center;
    padding: 20px;
    /* âœ… Fix: Add top padding to push the form down slightly */
    box-sizing: border-box;
  }

  /* 2. Main Form Container (Card) */
  .login_container {
    background-color: var(--bg-color-white);
    width: 100%;
    /* Fix: Remove fixed min-height to fit content */
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 0;
    /* Remove padding from this container */
    background: none;
    /* Make this container transparent */
  }

  /* 3. Form Title (Login) */
  .login_container h2 {
    margin-top: 0;
    margin-bottom: 0px;
    /* Increase bottom margin */
    color: var(--dark-blue);
    /* Darker and clearer color */
    font-size: clamp(28px, 6vw, 36px);
    /* Increase font size */
    font-weight: 700;
    text-align: center;
  }

  /* 4. The Form Itself */
  .login_container form {
    width: 100%;
    max-width: 420px;
    /* Modify max-width */
    /* NEW: Transparent glass effect */
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    padding: 40px;
    border-radius: 20px;
    /* More rounded corners */
    /* NEW: Softer and deeper shadow */
    box-shadow: var(--shadow-soft);
    border: 1px solid var(--border-color-soft);
  }

  /* 5. Input Field Group (Label and Field) */
  .login_form-group {
    margin-bottom: 20px;
    text-align: right;
    /* Align labels to the right */
    position: relative;
    /* Important for positioning the icon inside */
  }

  .login_form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark-blue);
    /* Dark gray color */
    font-size: 0.9rem;
  }

  /* 6. Input Fields */
  .login_form-group input {
    width: 100%;
    /* Fix: Full width of the container */
    padding: 14px 45px 14px 15px;
    /* Space for icon on the right */
    border: 1px solid var(--border-color-input);
    /* Lighter border color */
    border-radius: 10px;
    /* Increase border radius */
    box-sizing: border-box;
    font-family: "Tajawal", sans-serif;
    font-size: 16px;
    transition: border-color 0.3s, box-shadow 0.3s;
    background-color: var(--bg-color-white);
    /* Fix: Pure white background */
  }

  /* Icon container inside password input */
  .login_password-wrapper {
    position: relative;
  }



  /* Input field icons (in case of phone number) */
  .login_form-group .fa-phone,
  .login_form-group .fa-user {
    /* Fix: Improve icon alignment */
    position: absolute;
    top: 50%;
    right: 15px;
    /* To the right in RTL */
    transform: translateY(calc(-50% + 14px));
    /* Precise vertical alignment adjustment */
    color: var(--icon-color);
    cursor: pointer;
  }

  /* Style for input fields with validation errors */
  .login_form-group input.login_input-error {
    border-color: var(--danger-color);
    /* Red border for error */
  }

  .login_form-group input.login_input-error:focus {
    box-shadow: 0 0 0 3px var(--danger-color-light);
    /* Red shadow on focus */
  }

  /* Style for the error message below the input */
  .login_error-message {
    color: var(--danger-color);
    /* Red color for error text */
    font-size: 12px;
    margin-top: 5px;
    min-height: 15px;
    /* Reserve space to prevent layout shifts */
  }

  .login_form-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    /* Fix: Consistent blue color */
    box-shadow: var(--shadow-focus);
  }

  /* 7. Login Button */
  .login_btn {
    width: 100%;
    padding: 15px;
    font-size: clamp(16px, 4vw, 18px);
    /* Responsive font size */
    margin-top: 10px;
    border: none;
    color: white;
    background-color: var(--primary-color);
    box-shadow: 0 4px 15px var(--primary-color-light),
      inset 0 1px 0 rgba(255, 255, 255, 0.2);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: pointer;
    border-radius: 10px;
    /* Preferably add rounded corners to match fields */
  }

  .login_btn:active {
    transform: translateY(2px);
    box-shadow: 0 2px 8px var(--primary-color-light);
  }

  /* 8. Form Footer (Additional Links) */
  .login_form-footer {
    margin-top: 25px;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    align-items: center;
  }

  /* "Register Now" link: Appears as a primary secondary action */
  .login_form-footer-link {
    color: var(--primary-color);
    /* Clear blue color */
    font-size: 14px;
    /* Fix: Unify font size */
    text-decoration: none;
  }

  /* "Login as Guest" link: Appears as an alternative and less important option */
  .login_guest-link {
    color: var(--text-color-light);
    /* Gray color to make it less prominent */
    font-size: 14px;
    border-top: 1px solid var(--border-color);
    /* Slightly darker separator line */
    padding-top: 15px;
    /* Space above the link */
    width: 100%;
    /* Extend to full width of container */
    text-align: center;
    /* Center text */
    text-decoration: none;
  }

  /* Password toggle icon */
  .login_toggle-password {
    position: absolute;
    top: 50%;
    left: 15px;
    /* To the left in RTL */
    transform: translateY(calc(-50% + 14px));
    /* Precise vertical alignment adjustment */
    color: var(--icon-color);
    cursor: pointer;
  }

  /* Modify password field to place icon on the left */
  #login_password {
    padding-left: 45px;
    /* Space for eye icon on the left */
  }

  .login_form-footer a strong {
    font-weight: 700;
  }

  /* === Back to Home Button (in Header) - Kept as is as it's a header element, not part of the form === */
  .back-to-home-btn {
    display: flex;
    flex-direction: column;
    /* Stack icon and text vertically */
    align-items: center;
    gap: 2px;
    /* Reduce space between icon and text */
    font-family: "Tajawal", sans-serif;
    font-weight: 600;
    color: var(--dark-blue);
    /* âœ… Fix: Change button color to blue */
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 20px;
    transition: background-color 0.3s, color 0.3s;
  }

  .back-to-home-btn i {
    font-size: 16px;
    margin-bottom: 2px;
    /* Add small space below icon */
  }

  .back-to-home-btn span {
    font-size: 12px;
    /* Decrease text font size */
    white-space: nowrap;
    /* Prevent text splitting into two lines */
  }

  /* Media query for very small screens */
  @media (max-width: 480px) {
    .login_container form {
      padding: 30px 25px;
      /* Reduce padding for very small screens */
      /* NEW: Remove shadow and border on very small screens */
      box-shadow: none;
      border: none;
      background-color: transparent;
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
      /* For Safari compatibility */
    }

    .login_form-group {
      margin-bottom: 15px;
    }
  }
</style>

<div id="header-container1X" style="height: 70px"></div>

<div id="login_form-wrapper" class="login_page-wrapper" style="display: none">
  <div id="login_form-container" class="login_container">
    <h2 id="login_title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <form id="login_form">
      <div id="login_phone-form-group" class="login_form-group">
        <label for="login_phone"><i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input type="tel" id="login_phone" name="login_phone" required />
        <div id="login_phone-error" class="login_error-message"></div>
      </div>
      <div id="login_password-form-group" class="login_form-group">
        <label for="login_password"><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="login_password" name="login_password" required />
        <i class="fas fa-eye login_toggle-password" id="login_togglePassword"></i>
        <div id="login_password-error" class="login_error-message"></div>
      </div>
      <button type="submit" class="button login_btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <div id="login_form-footer" class="login_form-footer">
        <a href="#" id="login_go-to-register-link" class="login_form-footer-link">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <strong>Ø³Ø¬Ù„
            Ø§Ù„Ø¢Ù†</strong></a>
        <a id="login_guest-btn" class="login_guest-link">Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ <strong>Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ</strong> Ù„ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
      </div>
    </form>
  </div>
</div>
<script>
  /**
   * @file pages/login.html
   * @description Handles user login functionality, including form validation, authentication via API, and guest login access.
   */

  /**
   * @function loadPage
   * @description Main initialization function for the login page. Checks user session status and displays the login form only if the user is not logged in. Binds event handlers.
   * @async
   * @param {object} [params] - Optional parameters passed from the previous page.
   * @returns {Promise<void>}
   */
  async function loadPage(params) {
    try {
      // Refresh userSession from localStorage to ensure we have the latest state.
      // This prevents the code from believing the user is still logged in after logout
      // if the global userSession variable hasn't been updated yet.
      userSession = JSON.parse(localStorage.getItem("loggedInUser")) || null;

      // Check if a user is already logged in.
      if (Number(userSession?.is_seller) >= 1) {
        // Attempt to initialize notifications for the current user if logged in.
        if (typeof initializeNotifications === "function") {
          //  initializeNotifications();
        }
        // Stop execution to allow for redirection (redirection should happen elsewhere)
        return;
      }

      // Show login form only if no user is logged in.
      const loginFormWrapper = document.getElementById("login_form-wrapper");
      if (loginFormWrapper) {
        // Use 'flex' as it matches the CSS.
        loginFormWrapper.style.display = "flex";
      }

      // Setup login form.
      login_setupLoginForm();

    } catch (error) {
      console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ Ø¯Ø§Ù„Ø© loadPage:", error);
      // Show generic error to user using SweetAlert2.

    }
  }

  /**
   * @function login_setupLoginForm
   * @description Sets up all event listeners for the login form.
   * Includes: password visibility toggle, phone number sanitization, and submit event handler.
   * @returns {void}
   */
  function login_setupLoginForm() {
    try {
      // Get form elements
      const loginForm = document.getElementById("login_form");
      if (!loginForm) return;

      const loginPhoneInput = document.getElementById("login_phone");
      const loginPasswordInput = document.getElementById("login_password");
      const loginTogglePassword = document.getElementById("login_togglePassword");
      const loginGuestBtn = document.getElementById("login_guest-btn");

      // 1. Add password visibility toggle functionality
      if (loginTogglePassword && loginPasswordInput) {
        loginTogglePassword.addEventListener("click", function () {
          // Toggle input type
          const type =
            loginPasswordInput.getAttribute("type") === "password" ? "text" : "password";
          loginPasswordInput.setAttribute("type", type);
          // Toggle eye icon
          this.classList.toggle("fa-eye");
          this.classList.toggle("fa-eye-slash");
        });
      }

      // 2. Input event handler for phone number (sanitization)
      if (loginPhoneInput) {
        loginPhoneInput.addEventListener("input", function (e) {
          // Use `normalizeDigits` to convert Indic digits (e.g. 'Ù Ù¡Ù¢') to Arabic numerals ('012').
          const normalized = normalizeDigits(e.target.value);
          // Remove any non-numeric characters.
          e.target.value = normalized.replace(/[^0-9]/g, "");
        });
      }

      // 3. Login form submit handler
      loginForm.addEventListener("submit", login_handleSubmit);

      // 4. Bind "Login as Guest" button event.
      if (loginGuestBtn) {
        loginGuestBtn.addEventListener("click", login_handleGuestLogin);
      }

      // 5. Bind "Register Now" link event.
      const registerLink = document.getElementById("login_go-to-register-link");
      if (registerLink) {
        registerLink.addEventListener("click", login_handleRegisterClick);
      }

    } catch (error) {
      console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ Ø¯Ø§Ù„Ø© login_setupLoginForm:", error);
    }
  }

  /**
   * @function login_handleRegisterClick
   * @description Handles the click event on the "Register Now" link.
   * @param {Event} e - The event object.
   */
  function login_handleRegisterClick(e) {
    e.preventDefault();
    mainLoader("./pages/register.html", "index-user-container", 0, undefined, "hiddenLoginIcon", true);
  }


  /**
   * @function login_handleSubmit
   * @description Handles the login form submission. Validates inputs and communicates with the backend to verify credentials.
   * @async
   * @param {Event} e - The submit event object.
   * @returns {Promise<void>}
   */
  async function login_handleSubmit(e) {
    try {
      console.log(
        "%c[ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„] ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.",
        "color: blue; font-weight: bold;"
      );
      // Prevent default form submission.
      e.preventDefault();

      const loginPhoneInput = document.getElementById("login_phone");
      const loginPasswordInput = document.getElementById("login_password");

      // 1. Clear previous errors.
      if (typeof clearError === "function") {
        clearError(loginPhoneInput);
        clearError(loginPasswordInput);
      }

      // 2. Get values and validate inputs.
      const phoneValue = loginPhoneInput.value.trim();
      const passwordValue = loginPasswordInput.value.trim();
      let loginIsValid = true;

      // Validate Phone
      if (phoneValue === "") {
        showError(loginPhoneInput, "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø·Ù„ÙˆØ¨.");
        loginIsValid = false;
      } else if (phoneValue.length < 11) {
        showError(loginPhoneInput, "ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ù† 11 Ø±Ù‚Ù…Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        loginIsValid = false;
      }

      // Validate Password
      if (passwordValue === "") {
        showError(loginPasswordInput, "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©.");
        loginIsValid = false;
      } else if (passwordValue.length < 4) {
        showError(loginPasswordInput, "ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");
        loginIsValid = false;
      }

      // 3. If all inputs are valid.
      if (loginIsValid) {
        console.log("[ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„] Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØµØ§Ù„Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª...");

        // Show loading popup.
        Swal.fire({
          title: "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...",
          text: "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ø­Ø¸Ø©.",
          allowOutsideClick: false,
          didOpen: () => {
            // Show loading spinner.
            Swal.showLoading();
          },
          customClass: { popup: 'fullscreen-swal' }, // Apply custom style
        });

        // 4. Verify user credentials with server.
        const verificationResult = await verifyUserPassword(
          phoneValue,
          passwordValue
        );

        // 5. Handle verification result.
        if (verificationResult && !verificationResult.error) {

          login_handleLoginSuccess(verificationResult);
        } else {
          // Verification failed.
          console.error(
            "[ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„] ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:",
            verificationResult?.error || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
          );
          Swal.close();
          const errorMessage =
            "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ù….";
          if (typeof showError === "function") {
            showError(loginPasswordInput, errorMessage);
          }
        }
      }
    } catch (error) {
      console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ login_handleSubmit:", error);
      // Close loading popup and show error.

    }
  }

  /**
   * @function login_handleLoginSuccess
   * @description Handles actions after a successful login.
   * @param {object} user - The logged-in user object.
   * @async
   * @returns {Promise<void>}
   */
  async function login_handleLoginSuccess(user) {
    try {
      console.log(
        "%c[ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„] ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ login_handleLoginSuccess. Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:",
        "color: green;",
        user
      );

      // 1. Save user data and update session.
      localStorage.setItem("loggedInUser", JSON.stringify(user));
      userSession = user; // Update user session global object.
      setUserNameInIndexBar();
      // 2. Setup FCM notifications if eligible.
      if (userSession.user_key != "guest_user") {
        await setupFCM();
        await askForNotificationPermission();
      } else {
        console.log(
          "[ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„] Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¤Ù‡Ù„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŒ ØªØ®Ø·ÙŠ setupFCM()."
        );
      }

      // 3. Show welcome message and redirect to home.
      Swal.fire({
        title: `ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒØŒ ${userSession.username}! ğŸ‰`,
        html: `
        <p style="font-size: 1.1rem; color: #333;">Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ø¬Ø§Ù‡Ø² Ù„ØªØ¬Ø±Ø¨Ø© ØªØ³ÙˆÙ‚ ÙØ±ÙŠØ¯Ø©!</p>
        <div style="text-align: right; margin-top: 20px; padding-right: 15px; font-size: 1rem;">
          <p style="margin-bottom: 10px;">ğŸ›ï¸ ØªØµÙØ­ Ø¢Ù„Ø§Ù Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø³Ù‡ÙˆÙ„Ø©.</p>
          <p style="margin-bottom: 10px;">ğŸ’° Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø®ØµÙˆÙ…Ø§Øª ÙˆØ¹Ø±ÙˆØ¶ Ø­ØµØ±ÙŠØ©.</p>
          <p>âœ¨ Ø§ÙƒØªØ´Ù Ù…Ø§ Ù‡Ùˆ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆÙŠØ³.</p>
        </div>
      `,
        icon: "success",
        allowOutsideClick: false, // Prevent closing on click outside
        confirmButtonText: "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†!",
        confirmButtonColor: "#3b82f6",
        customClass: { popup: 'fullscreen-swal' }, // Apply custom style
      }).then((result) => {
        // Redirect to home page on button click.
        if (result.isConfirmed) {
          if (typeof mainLoader === "function") {
            mainLoader("./pages/home.html", "index-home-container", 0, undefined, "hiddenHomeIcon", true);
          }
        }
      });

    } catch (error) {
      console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ Ø¯Ø§Ù„Ø© login_handleLoginSuccess:", error);
    }
  }


  /**
   * @function login_handleGuestLogin
   * @description Handles guest login process. Creates a dummy guest user session.
   * @param {Event} event - The event object to prevent default link behavior.
   * @returns {void}
   */
  function login_handleGuestLogin(event) {
    try {
      event.preventDefault(); // Prevent link from updating page.
      console.log("[Auth] ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ¶ÙŠÙ.");

      // Create guest user object.
      const guestUser = {
        username: "Guest",
        is_guest: true,
        user_key: "guest_user",
        is_seller: -1,
        notifications_key: null, // Guest has no notifications key.
        notifications_enabled: false, // Notifications disabled for guest.
      };

      // Save guest data in localStorage and update session.
      localStorage.setItem("loggedInUser", JSON.stringify(guestUser));
      userSession = guestUser;
      setUserNameInIndexBar();
      // Reload home page fully to update UI.
      if (typeof mainLoader === "function") {
        mainLoader(
          "./pages/home.html",
          "index-home-container",
          0,
          undefined,
          "hiddenHomeIcon", true
        );
      }
    } catch (error) {
      console.error("ğŸš« Ø®Ø·Ø£ ÙÙŠ Ø¯Ø§Ù„Ø© login_handleGuestLogin:", error);
    }
  }



  loadPage();

  // This element is inserted in the way followed in the project (hgh_sec)
  insertUniqueSnapshot("pages/header.html", "header-container1X", 300);
</script>