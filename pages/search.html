<!--
@file pages/search.html
@description Search Modal Component. Provides product search functionality with category filters, sorting, and results display.
-->
<style>
  .loader {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 4px solid transparent;
    /* Set base border to transparent */
    border-top-color: var(--primary-color);
    /* Animate top border color */
    border-right-color: var(--primary-color);
    /* Animate right border color */
    animation: material-spin 0.7s linear infinite;
    margin: 40px auto;
  }

  @keyframes material-spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .search-modal-content {
    margin: 40px;
    background-color: transparent;
    /* Background color */
    animation: slide-down 0.5s ease-out forwards;
    text-align: right;
    /* ✅ EDIT: Align content to right to match language */
  }

  @keyframes slide-down {
    from {
      transform: translateY(-50px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* ✅ NEW: Modal fade-in effect */
  @keyframes fade-in {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  /* ✅ NEW: Container to group search field and button */
  .search-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    /* Gap between search field and button */
  }

  /* ✅ NEW: New search button styles */
  .search-button {
    flex-shrink: 0;
    /* Prevent button shrinking */
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: transparent;
    color: var(--primary-color);
    border: 1px solid var(--border-color-input);
    /* ✅ EDIT: Thinner border with light blue color */
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    box-shadow: var(--shadow-interactive);
    /* ✅ EDIT: More visible shadow */
  }

  /* ✅ NEW: Define pulse animation for search button */
  @keyframes pulse-animation {
    0% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
    }

    70% {
      transform: scale(1.05);
      box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
    }

    100% {
      transform: scale(1);
      box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
    }
  }

  .search-button.is-pulsing {
    animation: pulse-animation 1.5s infinite;
  }

  .search-modal-input-container {
    display: flex;
    align-items: center;
    position: relative;
    border: 1px solid var(--border-color-input);
    border-radius: 50px;
    overflow: hidden;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    /* ✅ EDIT: Remove padding from here */
    background-color: var(--bg-color-light);
    flex-grow: 1;
    /* Make search field fill available space */
  }

  .search-modal-input-container:focus-within {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-color-light);
    /* ✅ IMPROVE: Use color variable for glow */
  }

  /* ✅ NEW: Search icon styles inside input field */
  .search-modal-input-icon {
    font-style: normal;
    /* Remove italic style from <i> tag */
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1rem;
    transition: color 0.3s ease;
    /* ✅ EDIT: Add right padding to create space from container edge */
    padding-right: 20px;
  }

  /* ✅ NEW: Use ::before to show "txt" text instead of font-awesome icon */
  .search-modal-input-icon.fa-search::before {
    content: "txt";
    font-family: "Tajawal", sans-serif;
    /* Use consistent font */
  }

  .search-modal-input-icon.fa-search {
    font-family: "Font Awesome 5 Free";
    /* Fallback definition to avoid display issues */
  }

  /* ✅ NEW: Change search icon color on focus */
  #search-modal-input {
    flex-grow: 1;
    border: none;
    padding: 15px 20px;
    /* ✅ EDIT: Unify padding after relying on flexbox */
    font-size: 1.1rem;
    outline: none;
    background-color: transparent;
    width: 100%;
    /* ✅ NEW: To ensure filling space */
    box-sizing: border-box;
    /* ✅ NEW: To ensure padding is calculated correctly */
  }

  /* ✅ NEW: Change icon color when focusing on input field */
  .search-modal-input-container:focus-within .search-modal-input-icon {
    color: var(--primary-color);
  }

  /* ✅ NEW: Styles for show/hide filters link */
  .search-toggle-filters-link {
    display: block;
    /* ✅ EDIT: Change width to take full available space */
    text-align: center;
    /* ✅ NEW: Center text inside link */
    margin-top: 15px;
    color: var(--primary-color);
    text-decoration: none;
    font-weight: normal;
    cursor: pointer;
    /* Use pointer cursor for links */
    font-size: 1rem;
    /* ✅ EDIT: Unify font size with label text */
    transition: color 0.3s ease;
  }

  .search-toggle-filters-link i {
    transition: transform 0.3s ease;
  }

  /* ✅ NEW: Search icon styles inside field */

  /* ✅ NEW: Category filters container styles */
  .search-filters-container {
    display: flex;
    gap: 15px;
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .search-filter-group {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-filter-icon {
    position: absolute;
    right: 18px;
    /* ✅ EDIT: Improve positioning */
    color: var(--primary-color);
    pointer-events: none;
    /* To prevent icon from interfering with click */
    transition: color 0.3s ease;
    /* ✅ NEW: Add animation for color change */
  }

  /* ✅ NEW: Change filter icon color on focus */
  .search-filter-group:focus-within .search-filter-icon {
    color: var(--primary-color);
  }

  .search-category-filter {
    width: 100%;
    padding: 12px 45px 12px 20px;
    /* Padding to make room for icon */
    border: 1px solid var(--border-color-input);
    border-radius: 50px;
    background-color: var(--bg-color-light);
    font-family: "Tajawal", sans-serif;
    font-size: 0.95rem;
    color: var(--text-color-medium);
    cursor: pointer;
    -webkit-appearance: none;
    /* Remove browser default appearance */
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='var(--text-color-dark)' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: left 0.75rem center;
    background-size: 16px 12px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    /* ✅ IMPROVE: Add shadow effect */
  }

  .search-category-filter:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--primary-color-light);
    /* ✅ NEW: Add glow on focus */
  }

  .search-category-filter:disabled {
    background-color: var(--border-color);
    border-color: var(--border-color-input);
    cursor: not-allowed;
  }

  #search-results-container {
    margin-top: 20px;
    text-align: right;
    /* Align search results to right */
  }

  /* ✅ NEW: Grid styles for displaying search results */
  .search-results-grid {
    display: grid;
    /* Create responsive columns, min width 180px, max 1fr (part of available space) */
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
    /* Gap between items */
    padding-top: 10px;
  }

  /* ✅ NEW: Styles for each item in search grid */
  .search-result-item {
    background-color: var(--bg-color-white);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    /* To hide any parts of image exceeding rounded borders */
    box-shadow: var(--shadow-soft);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    flex-direction: column;
    text-align: right;
    /* Align text to right */
  }

  /* ✅ NEW: Product image styles in search result */
  .search-result-image {
    width: 100%;
    height: 160px;
    /* Fixed height for images to maintain consistency */
    object-fit: cover;
    /* To ensure image fills space without distortion */
  }

  /* ✅ NEW: Product details styles in search result */
  .search-result-details {
    padding: 15px;
    flex-grow: 1;
    /* To make this part fill remaining space */
    display: flex;
    flex-direction: column;
  }

  .search-result-title {
    font-size: 1rem;
    font-weight: bold;
    color: var(--text-color-dark);
    margin: 0 0 8px 0;
  }

  .search-result-price {
    font-size: 0.9rem;
    color: var(--primary-color);
    font-weight: bold;
    margin: auto 0 0 0;
    /* Push price to bottom */
  }

  /* ✅ NEW: Styles for small screens (Responsive) */
  @media (max-width: 768px) {
    .search-modal-content {
      width: 95%;
      /* Increase width slightly to better fill screen */
      margin: 20px auto;
      padding: 15px;
      max-width: none;
    }

    #search-modal-input {
      padding: 12px 15px 12px 10px;
      /* ✅ EDIT: Adjust padding to fit flexbox */
      font-size: 1rem;
      /* Reduce input font size */
    }

    /* ✅ NEW: Stack filters on small screens */
    .search-filters-container {
      flex-direction: column;
      gap: 10px;
    }

    .search-category-filter {
      padding: 10px 40px 10px 15px;
      font-size: 0.9rem;
    }

    /* ✅ NEW: Adjust column size on very small screens */
    .search-results-grid {
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
    }
  }
</style>


<div id="search-modal-content" class="search-modal-content">
  <table id="search-layout-table" style="width: 100%; border-spacing: 10px; table-layout: fixed">
    <tbody id="search-layout-tbody">
      <!-- First Row: Main and Sub Categories -->
      <tr id="search-filters-row">
        <td id="search-main-category-cell">
          <div id="search-main-category-filter-group" class="search-filter-group">
            <i id="search-main-category-filter-icon" class="fas fa-layer-group search-filter-icon"></i>
            <select id="search-main-category-filter" class="search-category-filter" aria-label="الفئة الرئيسية">
              <option id="search-main-category-default-option" value="">
                كل الاسواق الرئيسية
              </option>
            </select>
          </div>
        </td>
        <td id="search-sub-category-cell">
          <div class="search-filter-group" id="search-sub-category-filter-group">
            <i id="search-sub-category-filter-icon" class="fas fa-tags search-filter-icon"></i>
            <select id="search-sub-category-filter" class="search-category-filter" disabled aria-label="الفئة الفرعية">
              <option id="search-sub-category-default-option" value="">
                كل الاسواق الفرعية
              </option>
            </select>
          </div>
        </td>
      </tr>
      <!-- Second Row: Search Field -->
      <tr id="search-input-row">
        <td id="search-input-cell" colspan="2">
          <div id="search-modal-input-container" class="search-modal-input-container" style="padding-right: 0px">
            <i class="fas fa-search search-modal-input-icon" id="search-input-icon" aria-hidden="true"></i>
            <input type="search" id="search-modal-input" placeholder="اكتب اسم المنتج الذي تبحث عنه..."
              autocomplete="off" />
          </div>
        </td>
      </tr>
      <!-- Third Row: Sort Filter and Search Button -->
      <tr id="search-action-row">
        <td id="search-sort-cell">
          <div id="search-sort-filter-group" class="search-filter-group">
            <i id="search-sort-filter-icon" class="fas fa-sort-amount-down search-filter-icon"></i>
            <select id="search-sort-filter" class="search-category-filter" aria-label="ترتيب حسب">
              <option id="search-sort-default" value="default">
                الترتيب الافتراضي
              </option>
              <option id="search-sort-price-asc" value="price-asc">
                الأقل سعراً
              </option>
              <option id="search-sort-price-desc" value="price-desc">
                الأعلى سعراً
              </option>
            </select>
          </div>
        </td>
        <td id="search-button-cell">
          <button id="search-perform-search-btn" class="search-button" aria-label="بحث"
            style="width: 100%; height: 50px; border-radius: 50px">
            <i id="search-button-icon" class="fas fa-search"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>
  <div id="search-results-container"></div>
</div>

<script>
  /**
   * @function initSearchModal
   * @description Initializes the search modal by retrieving DOM elements and attaching event listeners.
   * @param {string} containerId - The ID of the container element for the search modal (unused in current logic but kept for signature).
   * @returns {Promise<void>}
   */
  async function initSearchModal(containerId) {
    // Developer message: Start initializing search modal
    console.log(
      "%c[SearchModal] Starting initialization of the search modal.",
      "color: #007bff; font-weight: bold;"
    );
    const searchModalInput = document.getElementById("search-modal-input");
    const mainCategoryFilter = document.getElementById(
      "search-main-category-filter"
    );
    const subCategoryFilter = document.getElementById(
      "search-sub-category-filter"
    );
    const subCategoryFilterGroup = document.getElementById(
      "search-sub-category-filter-group"
    );
    const searchResultsContainer = document.getElementById(
      "search-results-container"
    );
    const performSearchBtn = document.getElementById(
      "search-perform-search-btn"
    );
    const sortFilter = document.getElementById("search-sort-filter");
    let currentResults = [];
    // Developer message: DOM elements retrieved successfully
    console.log(
      "[SearchModal] All required DOM elements have been successfully retrieved."
    );

    /**
     * @function debounce
     * @description Delayed execution function (Debounce) to improve search performance while typing.
     * @param {function(...any): any} func - The function to be debounced.
     * @param {number} delay - The delay in milliseconds.
     * @returns {function(...any): void} - A modified function that executes the original function after the delay.
     */
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    /**
     * @function performSearch
     * @description Executes the search based on current criteria (text, main/sub categories).
     *   Shows loading indicator and then results or error message.
     * @returns {Promise<void>} - A Promise that resolves when search is complete.
     * @see normalizeArabicText
     * @see displaySearchResults
     */
    async function performSearch() {
      // Stop button animation once search starts
      performSearchBtn.classList.remove("is-pulsing");

      // Refine Arabic text before sending
      const searchTerm = normalizeArabicText(searchModalInput.value.trim());
      const mainCategory = mainCategoryFilter.value;
      const subCategory = subCategoryFilter.value;

      // Log search criteria
      console.info(
        `[SearchModal] Starting search with: searchTerm='${searchTerm}', mainCategory='${mainCategory}', subCategory='${subCategory}'`
      );

      // Do not search if empty
      if (!searchTerm && !mainCategory) {
        searchResultsContainer.innerHTML = ""; // Clear results
        return;
      }

      // Show loader
      searchResultsContainer.innerHTML = ""; // Clear previous results
      const loader = document.createElement("div"); // NOSONAR
      loader.className = "loader";
      loader.style.margin = "40px auto";
      searchResultsContainer.appendChild(loader);

      const params = new URLSearchParams();
      if (searchTerm) params.append("searchTerm", searchTerm);
      if (mainCategory) params.append("MainCategory", mainCategory);
      if (subCategory) params.append("SubCategory", subCategory);

      const searchURL = `${baseURL}/api/products?${params.toString()}`;
      // Log full request URL
      console.info(`[SearchModal] Fetching from URL: ${searchURL}`);

      try {
        const response = await fetch(searchURL);
        if (!response.ok) throw new Error("Failed to fetch search results");
        const results = await response.json();
        currentResults = results; // Store original results
        console.log(
          "[SearchModal] Successfully received results from server:",
          currentResults
        ); // Log received results
        displaySearchResults(results);
      } catch (error) {
        console.error("%c[SearchModal] Search Error:", "color: red;", error);
        searchResultsContainer.innerHTML = // NOSONAR
          '<p class="search-error-message">Error occurred during search. Please try again.</p>'; // NOSONAR
      }
      // Notify developer search is complete
      console.log(
        "%c[SearchModal] Search operation completed.",
        "color: blue; font-style: italic;"
      );
    }

    /**
     * @function displaySearchResults
     * @description Displays search results in the UI, applying sort options if any.
     *   Attaches click events to product cards to open details modal.
     * @param {Array<Object>} results - Array of product objects.
     * @returns {void}
     * @see showProductDetails
     */
    function displaySearchResults(results) {
      // Developer message: Start displaying results
      console.log("[SearchModal] Starting to display search results.");
      let sortedResults = [...results]; // Copy results for sorting
      const sortValue = sortFilter.value;

      // Apply sorting logic
      if (sortValue === "price-asc") {
        console.info("[SearchModal] Sorting results by price: Low to High.");
        sortedResults.sort(
          (a, b) => parseFloat(a.product_price) - parseFloat(b.product_price)
        );
      } else if (sortValue === "price-desc") {
        console.info("[SearchModal] Sorting results by price: High to Low.");
        sortedResults.sort(
          (a, b) => parseFloat(b.product_price) - parseFloat(a.product_price)
        );
      }

      // Log number of results
      console.log(
        `[SearchModal] Preparing to display ${sortedResults.length} search results.`
      );

      if (sortedResults.length === 0) {
        searchResultsContainer.innerHTML = // NOSONAR
          '<p class="search-no-results-message">No products found matching your search.</p>';
        return;
      }

      let resultsHTML = '<div class="search-results-grid">';
      sortedResults.forEach((product) => {
        // NOSONAR
        // Call unified function
        resultsHTML += generateSearchResultHTML(product);
      });
      resultsHTML += "</div>";
      searchResultsContainer.innerHTML = resultsHTML;

      // Add click event to each result to open product details
      document.querySelectorAll(".search-result-item").forEach((item) => {
        // NOSONAR
        item.addEventListener("click", () => {
          const productKey = item.dataset.productKey;
          const productData = sortedResults.find(
            (p) => p.product_key === productKey
          );
          // Hide search modal and pass a callback to reopen it? (Not implemented here, but implied)
          // Developer message: Product clicked
          console.log(
            "%c[Search Result Click] Product Clicked:",
            "color: #20c997; font-weight: bold;",
            productData
          );

          // Restructure product data for modal
          const productDataForModal = {
            product_key: productData.product_key,
            productName: productData.productName,
            user_key: productData.user_key,
            pricePerItem: productData.product_price, // Use product_price
            original_price: productData.original_price,
            imageSrc: productData.ImageName
              ? productData.ImageName.split(",").map(
                (name) =>
                  `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${name}`
              )
              : [],
            availableQuantity: productData.product_quantity,
            sellerMessage: productData.user_message,
            description: productData.product_description,
            sellerName: productData.seller_username,
            sellerPhone: productData.seller_phone,
            MainCategory: productData.MainCategory, // Pass Main Category ID
            SubCategory: productData.SubCategory, // Pass Sub Category ID
            type: productData.serviceType,
          };
          productSession = [productDataForModal, true];
          productViewLayout(productDataForModal.type);
        });
      });
    }

    // Add event listener for sort change
    sortFilter.addEventListener("change", () => {
      // Developer message: Sort changed
      console.log(
        `[SearchModal] Sort option changed to: ${sortFilter.value}. Re-displaying results.`
      );
      // Redisplay results with new sort
      displaySearchResults(currentResults);
    });
    /**
     * @function loadCategoryFilters
     * @description Fetches categories from `shared/list.json` and populates main/sub category filters.
     *   Sets up event listeners to update sub-categories when main category changes.
     * @returns {Promise<void>}
     * @throws {Error} - If loading categories fails.
     */
    async function loadCategoryFilters() {
      // Developer message: Start loading category filters
      console.log(
        "[SearchModal] Starting to load category filters from 'list.json'."
      );
      try {
        const response = await fetch("../shared/list.json");
        if (!response.ok) throw new Error("Failed to load category filters");
        const data = await response.json();
        const categories = data.categories;

        // Developer message: list.json loaded successfully
        console.log(
          "[SearchModal] 'list.json' loaded and parsed successfully.",
          categories
        );
        // 1. Populate Main Category Filter
        categories.forEach((category) => {
          const option = document.createElement("option"); // NOSONAR
          option.value = category.id;
          option.textContent = category.title;
          // Store subcategories in dataset
          option.dataset.subcategories = JSON.stringify(
            category.subcategories || []
          );
          mainCategoryFilter.appendChild(option);
        });

        // 2. Add event on Main Category change
        // Developer message: Attach event
        console.log(
          "[SearchModal] Attaching 'change' event listener to the main category filter."
        );
        mainCategoryFilter.addEventListener("change", () => {
          // Reset Sub Categories
          subCategoryFilter.innerHTML = // NOSONAR
            '<option value="">كل الاسواق الفرعية</option>';
          const selectedOption =
            mainCategoryFilter.options[mainCategoryFilter.selectedIndex];

          if (selectedOption.value) {
            const subcategories = JSON.parse(
              selectedOption.dataset.subcategories
            );
            if (subcategories.length > 0) {
              subcategories.forEach((sub) => {
                const subOption = document.createElement("option"); // NOSONAR
                subOption.value = sub.id;
                subOption.textContent = sub.title;
                subCategoryFilter.appendChild(subOption);
              });
              subCategoryFilter.disabled = false; // Enable sub category filter
            } else {
              subCategoryFilter.disabled = true; // Disable if no sub categories
            }
          } else {
            subCategoryFilter.innerHTML = // NOSONAR
              '<option value="">كل الاسواق الفرعية</option>'; // Reset
            subCategoryFilter.disabled = true; // Disable
          }
          // Developer message: Sub updated
          console.log(
            "[SearchModal] Sub-category filter updated based on main category selection."
          );
        });
      } catch (error) {
        console.error(
          "%c[SearchModal] Error loading category filters:",
          "color: red;",
          error
        );
      }
      // Developer message: Completed
      console.log(
        "[SearchModal] Category filters have been fully loaded and configured."
      );
    }

    // Call function to load filters
    loadCategoryFilters();

    // Attach search events
    // Developer message: Attach search events
    console.log(
      "[SearchModal] Attaching search event listeners to input fields and buttons."
    );
    // Search only on button click now

    if (performSearchBtn) {
      performSearchBtn.addEventListener("click", performSearch);
    } else {
      // Error message if button not found
      console.error(
        "[SearchModal] Search button (perform-search-btn) not found."
      );

      // Add input animation event
      searchModalInput.addEventListener("input", () => {
        if (searchModalInput.value.trim() !== "") {
          performSearchBtn.classList.add("is-pulsing");
        } else {
          performSearchBtn.classList.remove("is-pulsing");
        }
      });

      setTimeout(() => searchModalInput.focus(), 50);
    }

    // Developer message: Init complete
    console.log(
      "%c[SearchModal] Initialization complete. The search modal is ready.",
      "color: green; font-weight: bold;"
    );
  }

  function generateSearchResultHTML(product) {
    let SERVICE_CATEGORY_NoPrice_ID = 6;
    // Handle images
    const firstImageName = product.ImageName
      ? product.ImageName.split(",")[0]
      : null;
    const imageUrl = firstImageName
      ? `https://pub-e828389e2f1e484c89d8fb652c540c12.r2.dev/${firstImageName}`
      : "images/placeholder.png";

    // Determine if service
    const isService = product.MainCategory == SERVICE_CATEGORY_NoPrice_ID;
    const price = parseFloat(product.product_price);

    // Build HTML for search result
    return `
    <div class="search-result-item" data-product-key="${product.product_key}">
      <img src="${imageUrl}" alt="${product.productName
      }" class="search-result-image">
      <div class="search-result-details">
        <h4 class="search-result-title">${product.productName}</h4>
        ${!isService
        ? `<p class="search-result-price">${price.toFixed(2)} جنيه</p>`
        : ""
      }
      </div>
    </div>
  `;
  }

  window.addEventListener("message", async function listener(event) {
    // التحقق من أن الرسالة هي من النوع الصحيح ('ASSETS_INJECTED')
    if (event.data.type === "ASSETS_INJECTED") {
      // ✅ رسالة للمطور: تم استقبال رسالة تحميل الأصول
      console.log(
        "[Search Page] 'ASSETS_INJECTED' message received. Initializing search modal."
      );

      await initSearchModal("search-modal-container");

      window.removeEventListener("message", listener); // إزالة المستمع بعد الاستخدام
    }
  });

  initSearchModal("search-modal-content");
</script>