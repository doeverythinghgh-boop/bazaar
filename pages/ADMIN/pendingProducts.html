<style>
    .pending-products-container {
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: right;
        direction: rtl;
    }

    .pending-products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }

    .pending-products-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .pending-products-table th,
    .pending-products-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        text-align: right;
    }

    .pending-products-table th {
        background-color: #f8f9fa;
        color: #333;
        font-weight: bold;
    }

    .pending-products-table tr:hover {
        background-color: #f1f1f1;
    }

    .btn-approve {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 5px;
    }

    .btn-delete {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
    }

    .btn-approve:hover {
        background-color: #218838;
    }

    .btn-delete:hover {
        background-color: #c82333;
    }

    .no-pending-products {
        text-align: center;
        padding: 40px;
        color: #777;
        font-size: 1.1em;
    }
</style>

<div class="pending-products-container">
    <div class="pending-products-header">
        <h2 style="margin: 0; color: #333;">المنتجات المنشورة</h2>
        <button onclick="fetchPendingProducts()"
            style="background: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
            <i class="fas fa-sync-alt"></i> تحديث
        </button>
    </div>

    <div id="pending-products-list">
        <div class="loader" style="margin: 50px auto;"></div>
    </div>
</div>

<script>
    /**
     * Logic for fetching, displaying, and managing PUBLISHED products.
     */
    async function fetchPendingProducts() {
        const listContainer = document.getElementById('pending-products-list');
        listContainer.innerHTML = '<div class="loader" style="margin: 50px auto;"></div>';

        try {
            // Fetch products with status=1 (PUBLISHED)
            console.log("Fetching published products...");
            const response = await fetch(`${baseURL}/api/products?status=1`);
            if (!response.ok) throw new Error('فشل جلب المنتجات المنشورة');

            const products = await response.json();
            console.log("Products fetched:", products);

            if (!products || products.length === 0) {
                listContainer.innerHTML = `
                    <div class="no-pending-products">
                        <i class="fas fa-info-circle" style="font-size: 3em; color: #17a2b8; margin-bottom: 20px;"></i>
                        <p>لا توجد منتجات منشورة حالياً.</p>
                    </div>
                `;
                return;
            }

            renderPendingProducts(products);

        } catch (error) {
            console.error('Error fetching published products:', error);
            listContainer.innerHTML = `<p style="color: red; text-align: center;">حدث خطأ أثناء تحميل المنتجات: ${error.message}</p>`;
        }
    }

    function renderPendingProducts(products) {
        const listContainer = document.getElementById('pending-products-list');

        let tableHtml = `
            <table class="pending-products-table">
                <thead>
                    <tr>
                        <th>اسم المنتج</th>
                        <th>اسم البائع</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
        `;

        products.forEach(product => {
            tableHtml += `
                <tr id="row-${product.product_key}">
                    <td>
                        <div style="font-weight: bold;">${product.productName}</div>
                        <div style="font-size: 0.85em; color: #777;">${product.product_price} ج.م</div>
                    </td>
                    <td>
                        <div>${product.seller_username || 'غير معروف'}</div>
                        <div style="font-size: 0.85em; color: #777;">${product.seller_phone || '-'}</div>
                    </td>
                    <td>
                        <button class="btn-approve" style="background-color: #ffc107; color: #000;" onclick="unpublishProduct('${product.product_key}', '${product.productName}')" title="إلغاء النشر">
                            <i class="fas fa-ban"></i> إلغاء النشر
                        </button>
                        <button class="btn-delete" onclick="rejectProduct('${product.product_key}', '${product.productName}')" title="حذف المنتج">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
        `;

        listContainer.innerHTML = tableHtml;
    }

    function getCategoryName(id) {
        return `ID: ${id}`;
    }

    async function unpublishProduct(productKey, productName) {
        const confirmResult = await Swal.fire({
            title: 'إلغاء النشر',
            text: `هل أنت متأكد من إلغاء نشر "${productName}"؟ (سيعود لقائمة الانتظار)`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم، إلغاء النشر',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#ffc107'
        });

        if (!confirmResult.isConfirmed) return;

        try {
            Swal.showLoading();
            const response = await fetch(`${baseURL}/api/products`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    product_key: productKey,
                    is_approved: 0
                })
            });

            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'فشل التحديث');

            Swal.fire({
                icon: 'success',
                title: 'تم إلغاء النشر',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });

            const row = document.getElementById(`row-${productKey}`);
            if (row) {
                row.style.transition = 'all 0.5s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    if (document.querySelectorAll('.pending-products-table tbody tr').length === 0) {
                        fetchPendingProducts();
                    }
                }, 500);
            }

        } catch (error) {
            console.error(error);
            Swal.fire('خطأ', error.message, 'error');
        }
    }

    async function rejectProduct(productKey, productName) {
        const confirmResult = await Swal.fire({
            title: 'حذف المنتج',
            text: `هل تريد حذف "${productName}" نهائياً؟`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم، حذف',
            cancelButtonText: 'إلغاء',
            confirmButtonColor: '#dc3545'
        });

        if (!confirmResult.isConfirmed) return;

        try {
            Swal.showLoading();
            const response = await fetch(`${baseURL}/api/products?product_key=${productKey}`, {
                method: 'DELETE'
            });

            const result = await response.json();

            if (!response.ok) throw new Error(result.error || 'فشل الحذف');

            Swal.fire({
                icon: 'success',
                title: 'تم الحذف',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000
            });

            const row = document.getElementById(`row-${productKey}`);
            if (row) {
                row.style.transition = 'all 0.5s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    if (document.querySelectorAll('.pending-products-table tbody tr').length === 0) {
                        fetchPendingProducts();
                    }
                }, 500);
            }

        } catch (error) {
            console.error(error);
            Swal.fire('خطأ', error.message, 'error');
        }
    }

    // Initial fetch
    fetchPendingProducts();
</script>