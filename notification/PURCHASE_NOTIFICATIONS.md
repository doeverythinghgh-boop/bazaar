# โ ูุธุงู ุฅุดุนุงุฑุงุช ุงูุดุฑุงุก (Checkout Notifications)

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุฅุดุนุงุฑุงุช ุงูุดุฑุงุก ูุนูู ุจุงููุนู ููุชูุงูู ูุน ููุธููุฉ ุงูุฅุดุนุงุฑุงุช ุงูููุญุฏุฉ. ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ ุนูุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก" (`cartPage_checkoutBtn`).

---

## ๐ฏ **ุขููุฉ ุงูุนูู**

### **ุชุฏูู ุงูุนูููุฉ ุงููุงูู:**

```
ุงููุณุชุฎุฏู ูุถุบุท ุนูู "ุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก"
         โ
ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
         โ
ุงูุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช ูู ุงูุณูุฉ
         โ
ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ ุงูุทูุจ
         โ
ุงููุณุชุฎุฏู ูุคูุฏ ุงูุทูุจ
         โ
ุฅุฑุณุงู ุงูุทูุจ ุฅูู ุงูุฎุงุฏู (createOrder)
         โ
โ ุงูุทูุจ ุชู ุฅูุดุงุคู ุจูุฌุงุญ
         โ
๐ข handlePurchaseNotifications()
โโ notifyAdminOnPurchase() โ ุฅุดุนุงุฑ ุงูุฅุฏุงุฑุฉ
โโ notifySellersOnPurchase() โ ุฅุดุนุงุฑ ุงูุจุงุฆุนูู
         โ
ุชูุธูู ุงูุณูุฉ (clearCart)
         โ
ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ
```

---

## ๐ **ุงูุฅุดุนุงุฑุงุช ุงูููุฑุณูุฉ**

### **1๏ธโฃ ุฅุดุนุงุฑ ุงูุฅุฏุงุฑุฉ**

**ุงููุณุชูู:** ุฌููุน ุงููุณุคูููู (Admins)

**ุงูุฑุณุงูุฉ:**
```
ุงูุนููุงู: ุทูุจ ุดุฑุงุก ุฌุฏูุฏ
ุงููุต: ุชู ุงุณุชูุงู ุทูุจ ุฌุฏูุฏ ุฑูู #abc123. ุชุญูู ูู ุงูุชูุงุตูู ูู ููุญุฉ ุงูุชุญูู.
```

**ุงูููุฏ ุงููุณุคูู:**
```javascript
// ูู notificationTools.js - ุงูุณุทุฑ 355-369
async function notifyAdminOnPurchase(order) {
    const adminTokens = await getAdminTokens();
    if (adminTokens.length > 0) {
        const title = "ุทูุจ ุดุฑุงุก ุฌุฏูุฏ";
        const body = `ุชู ุงุณุชูุงู ุทูุจ ุฌุฏูุฏ ุฑูู #${order.id || 'N/A'}. ุชุญูู ูู ุงูุชูุงุตูู ูู ููุญุฉ ุงูุชุญูู.`;
        await sendNotificationsToTokens(adminTokens, title, body);
    }
}
```

---

### **2๏ธโฃ ุฅุดุนุงุฑ ุงูุจุงุฆุนูู**

**ุงููุณุชูููู:** ุฌููุน ุงูุจุงุฆุนูู ุงูุฐูู ุชู ุดุฑุงุก ููุชุฌุงุชูู

**ุงูุฑุณุงูุฉ:**
```
ุงูุนููุงู: ูุจูุนุงุช ุฌุฏูุฏุฉ!
ุงููุต: ุทูุจ ุดุฑุงุก. ุชููุฏ ุงูุทูุจุงุช ุงูุขู.
```

**ุงูููุฏ ุงููุณุคูู:**
```javascript
// ูู notificationTools.js - ุงูุณุทุฑ 377-414
async function notifySellersOnPurchase(order) {
    // ุชุฌููุน ุงูุจุงุฆุนูู ุงููุฑูุฏูู
    const sellersMap = new Map();
    order.items.forEach(item => {
        if (item.seller_key) {
            if (!sellersMap.has(item.seller_key)) {
                sellersMap.set(item.seller_key, []);
            }
            sellersMap.get(item.seller_key).push(item.name || 'ููุชุฌ');
        }
    });
    
    // ุฅุฑุณุงู ุฅุดุนุงุฑ ููู ุจุงุฆุน
    for (const [sellerKey, products] of sellersMap) {
        const sellerTokens = await getUsersTokens([sellerKey]);
        if (sellerTokens.length > 0) {
            const title = "ูุจูุนุงุช ุฌุฏูุฏุฉ!";
            const body = `ุทูุจ ุดุฑุงุก. ุชููุฏ ุงูุทูุจุงุช ุงูุขู.`;
            await sendNotificationsToTokens(sellerTokens, title, body);
        }
    }
}
```

---

## ๐ง **ุงููููุงุช ุงููุนููุฉ**

### **1. `js/cart-modal.js`**

**ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ:** `sendOrder2Excution()`

**ุงูุฎุทูุงุช:**
1. ุฌูุจ ุงูุณูุฉ (`getCart()`)
2. ุงูุชุญูู ูู ุชุณุฌูู ุงูุฏุฎูู
3. ุงูุชุญูู ูู ุงูุณูุฉ
4. ุญุณุงุจ ุงููุจูุบ ุงูุฅุฌูุงูู
5. ุฅูุดุงุก ููุชุงุญ ุงูุทูุจ (`generateOrderKey()`)
6. ุนุฑุถ ูุงูุฐุฉ ุชุฃููุฏ
7. ุฅุฑุณุงู ุงูุทูุจ (`createOrder()`)
8. **ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช** (`handlePurchaseNotifications()`) โ **ููุง**
9. ุชูุธูู ุงูุณูุฉ
10. ุนุฑุถ ุฑุณุงูุฉ ุงููุฌุงุญ

**ุงูููุฏ ุงูุฎุงุต ุจุงูุฅุดุนุงุฑุงุช (ุงูุณุทุฑ 193-200):**
```javascript
// 8. ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุจุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ
if (typeof handlePurchaseNotifications === 'function') {
    const finalOrderForNotify = { ...orderData, id: createdOrderKey };
    handlePurchaseNotifications(finalOrderForNotify)
        .catch(err => console.error('[Checkout] ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช:', err));
} else {
    console.warn('[Checkout] ุฏุงูุฉ handlePurchaseNotifications ุบูุฑ ูุชููุฑุฉ');
}
```

---

### **2. `notification/notificationTools.js`**

**ุงูุฏูุงู:**

#### ุฃ) `handlePurchaseNotifications(order)`
- **ุงูุบุฑุถ:** ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ูุฅุฏุงุฑุฉ ุฅุดุนุงุฑุงุช ุงูุดุฑุงุก
- **ุงููุนุงููุงุช:** `order` - ูุงุฆู ุงูุทูุจ
- **ุงูุณุทูุฑ:** 334-347

#### ุจ) `notifyAdminOnPurchase(order)`
- **ุงูุบุฑุถ:** ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฅุฏุงุฑุฉ
- **ุงูุณุทูุฑ:** 355-369

#### ุฌ) `notifySellersOnPurchase(order)`
- **ุงูุบุฑุถ:** ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ููุจุงุฆุนูู
- **ุงูุณุทูุฑ:** 377-414

---

### **3. `pages/cardPackage.html`**

**ุฒุฑ ุงูุดุฑุงุก (ุงูุณุทุฑ 534-536):**
```html
<button class="cartPage_checkout-btn" id="cartPage_checkoutBtn">
    <i class="fas fa-lock"></i> ุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก
</button>
```

**Event Listener (ุงูุณุทุฑ 842-853):**
```javascript
document.getElementById('cartPage_checkoutBtn').addEventListener('click', async function () {
    try {
        const cartPage_cart = getCart();
        if (cartPage_cart.length === 0) {
            return;
        }
        // ููุทู ุฅุชูุงู ุงูุดุฑุงุก ููุง
        await sendOrder2Excution();
    } catch (error) {
        console.error('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุชูุงู ุงูุดุฑุงุก:', error);
    }
});
```

---

## ๐ **ุงูุชูุงูู ูุน ูุธุงู ุงูุฅุดุนุงุฑุงุช ุงูููุญุฏ**

### **ุงูุฏูุงู ุงููุดุชุฑูุฉ:**

| ุงูุฏุงูุฉ | ุงูุงุณุชุฎุฏุงู |
|--------|-----------|
| `getUsersTokens()` | ุฌูุจ ุชูููุงุช ุงููุณุชุฎุฏููู (ุงูุจุงุฆุนูู) |
| `getAdminTokens()` | ุฌูุจ ุชูููุงุช ุงูุฅุฏุงุฑุฉ |
| `sendNotificationsToTokens()` | ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ุนุจุฑ FCM |

### **ุงููููุฒุงุช ุงููุดุชุฑูุฉ:**

- โ **ุฅุฑุณุงู ูุชูุงุฒู** - ุฌููุน ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู ุจุงูุชูุงุฒู
- โ **ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ** - `try-catch` ูู ูู ุฏุงูุฉ
- โ **ุชุณุฌูู ููุตู** - Console logging ููู ุฎุทูุฉ
- โ **ุขูู** - ูุดู ุงูุฅุดุนุงุฑุงุช ูุง ูุคุซุฑ ุนูู ุฅุชูุงู ุงูุทูุจ

---

## ๐ **ุจููุฉ ุจูุงูุงุช ุงูุทูุจ**

```javascript
const orderData = {
    order_key: "abc123",        // ููุชุงุญ ุงูุทูุจ ุงููุฑูุฏ
    user_key: "user_key_1",     // ููุชุงุญ ุงููุดุชุฑู
    total_amount: 150.50,       // ุงููุจูุบ ุงูุฅุฌูุงูู
    items: [
        {
            product_key: "product_key_1",
            quantity: 2,
            seller_key: "seller_key_1",
            note: "ููุงุญุธุฉ ุฎุงุตุฉ"
        },
        {
            product_key: "product_key_2",
            quantity: 1,
            seller_key: "seller_key_2",
            note: ""
        }
    ]
};
```

---

## ๐ **ูุง ุณุชุฑุงู ูู Console**

### **ุนูุฏ ุงูุถุบุท ุนูู "ุฅุชูุงู ุนูููุฉ ุงูุดุฑุงุก":**

```
[Checkout] ุฌุงุฑู ุฅุฑุณุงู ุจูุงูุงุช ุงูุทูุจ: {order_key: "abc123", ...}
[Checkout] ุงูุงุณุชุฌุงุจุฉ ูู ุงูุฎุงุฏู: {order_key: "abc123", ...}
[Checkout] ุชู ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ: abc123
[Notifications] ูุนุงูุฌุฉ ุฅุดุนุงุฑุงุช ุงูุดุฑุงุก ููุทูุจ: abc123
[Notifications] ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุฅุฏุงุฑุฉ.
[Notifications] ุชู ุงูุนุซูุฑ ุนูู 2 ุจุงุฆุนูู ูุฅุฎุทุงุฑูู.
[Notifications] ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุจุงุฆุน seller_key_1.
[Notifications] ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ููุจุงุฆุน seller_key_2.
```

---

## ๐ก **ููุงุญุธุงุช ูููุฉ**

### **1. ุงูุชูููุช:**
- ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู **ุจุนุฏ** ุฅูุดุงุก ุงูุทูุจ ุจูุฌุงุญ
- ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู **ูุจู** ุชูุธูู ุงูุณูุฉ
- ูุดู ุงูุฅุดุนุงุฑุงุช **ูุง ูุคุซุฑ** ุนูู ุฅุชูุงู ุงูุทูุจ

### **2. ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
```javascript
handlePurchaseNotifications(finalOrderForNotify)
    .catch(err => console.error('[Checkout] ุฎุทุฃ ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช:', err));
```
- ุงุณุชุฎุฏุงู `.catch()` ูุถูุงู ุนุฏู ุชููู ุงูุชูููุฐ
- ุงูุฃุฎุทุงุก ุชูุณุฌู ูู Console ููุท

### **3. ุงูุจุงุฆุนูู ุงููุฑูุฏูู:**
- ูุชู ุชุฌููุน ุงูุจุงุฆุนูู ุจุงุณุชุฎุฏุงู `Map`
- ูู ุจุงุฆุน ูุณุชูู ุฅุดุนุงุฑ ูุงุญุฏ ููุท ุญุชู ูู ูุงู ูู ุนุฏุฉ ููุชุฌุงุช

---

## ๐จ **ุงูุชุญุณููุงุช ุงูููุชุฑุญุฉ (ุงุฎุชูุงุฑูุฉ)**

### **1. ุฑุณุงุฆู ุฃูุซุฑ ุชูุตููุงู ููุจุงุฆุนูู:**
```javascript
const productCount = products.length;
const productNames = products.slice(0, 2).join(', ');
const body = `ูุฏูู ${productCount} ููุชุฌ${productCount > 1 ? 'ุงุช' : ''} ูู ุทูุจ ุฌุฏูุฏ (${productNames}${productCount > 2 ? '...' : ''}).`;
```

### **2. ุฅุดุนุงุฑ ูููุดุชุฑู:**
```javascript
async function notifyBuyerOnPurchase(order) {
    const buyerTokens = await getUsersTokens([order.user_key]);
    if (buyerTokens.length > 0) {
        const title = "ุชู ุงุณุชูุงู ุทูุจู";
        const body = `ุดูุฑุงู ูู! ุชู ุงุณุชูุงู ุทูุจู ุฑูู #${order.id}. ุณูุจุฏุฃ ูู ูุนุงูุฌุชู ูุฑูุจุงู.`;
        await sendNotificationsToTokens(buyerTokens, title, body);
    }
}
```

### **3. ุฅุถุงูุฉ ุฑูู ุงูุทูุจ ูู ุฑุณุงูุฉ ุงูุจุงุฆุน:**
```javascript
const body = `ุทูุจ ุดุฑุงุก ุฌุฏูุฏ #${order.id}. ุชููุฏ ุงูุทูุจุงุช ุงูุขู.`;
```

---

## โ **ุงูุฎูุงุตุฉ**

**ูุธุงู ุฅุดุนุงุฑุงุช ุงูุดุฑุงุก:**

| ุงูููุฒุฉ | ุงูุญุงูุฉ |
|--------|--------|
| **ูุชูุงูู ูุน ุงููุธุงู ุงูููุญุฏ** | โ ูุนู |
| **ูุนูู ุชููุงุฆูุงู** | โ ูุนู |
| **ุฅุดุนุงุฑ ุงูุฅุฏุงุฑุฉ** | โ ูุนู |
| **ุฅุดุนุงุฑ ุงูุจุงุฆุนูู** | โ ูุนู |
| **ุฅุดุนุงุฑ ุงููุดุชุฑู** | โ๏ธ ุงุฎุชูุงุฑู (ูููู ุฅุถุงูุชู) |
| **ูุนุงูุฌุฉ ุฃุฎุทุงุก** | โ ูุนู |
| **ุชุณุฌูู Console** | โ ูุนู |

**ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู ุชููุงุฆูุงู ุนูุฏ ูู ุนูููุฉ ุดุฑุงุก ูุงุฌุญุฉ!** ๐

---

## ๐ **ุงููููุงุช ุฐุงุช ุงูุตูุฉ**

1. โ `js/cart-modal.js` - ููุทู ุงูุดุฑุงุก
2. โ `notification/notificationTools.js` - ุฏูุงู ุงูุฅุดุนุงุฑุงุช
3. โ `pages/cardPackage.html` - ูุงุฌูุฉ ุงูุณูุฉ
4. โ `steper/NOTIFICATIONS_DOCUMENTATION.md` - ุชูุซูู ุงููุฑุงุญู ุงูุฑุฆูุณูุฉ
5. โ `steper/SUB_STEPS_NOTIFICATIONS.md` - ุชูุซูู ุงููุฑุงุญู ุงููุฑุนูุฉ

---

**ุชุงุฑูุฎ ุงููุฑุงุฌุนุฉ**: 2025-12-11  
**ุงูุญุงูุฉ**: โ ูุนูู ููุชูุงูู ูุน ุงูููุธููุฉ ุงูููุญุฏุฉ
