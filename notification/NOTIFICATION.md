# نظام الإشعارات المركزي (Architecture Report)

هذا التقرير يوضح الهيكل النهائي والمنطق البرمجي لنظام الإشعارات في المشروع، مع التركيز على ميزات الاستهداف الذقيق والفلترة العالمية.

---

## 1. إدارة الإعدادات والتحكم
يتم التحكم في تفعيل/تعطيل الإشعارات لكل طرف (مشتري، بائع، مندوب، إدارة) عبر ملف إعدادات مركزي.

### أ. التخزين المنسدل (`Cloudflare R2`)
- **الملف:** `notification_config.json` مخزن سحابياً لضمان المزامنة الفورية.
- **الإدارة:** واجهة `notification/page/settings.js` تسمح للمدير بتعديل الإعدادات في وقت التشغيل.

### ب. محرك التحقق (`notificationTools.js`)
- **الدالة:** `shouldNotify(stepId, role)`
- **الوظيفة:** تقوم بفحص الإعدادات العالمية قبل تنفيذ أي عملية إرسال، مما يضمن احترام خصوصية المستخدمين وقرارات الإدارة.

---

## 2. استراتيجية الاستهداف (Targeting Strategy)

تم الانتقال من الإشعارات الجماعية للطلب بالكامل إلى **الإشعارات الموجهة على مستوى المنتج (Item-level Awareness)**.

### أ. تتبع الهوية في الذاكرة
يتم حفظ `seller_key` لكل منتج في بنية البيانات المحلية (`stateManagement.js`) عند تحميل الطلب، مما يسمح للنظام بمعرفة صاحب كل منتج فوراً.

### ب. الدوال الذكية للاستخراج (`steperNotificationLogic.js`)
- `extractRelevantSellerKeys`: ترجع قائمة بالبائعين المتأثرين فقط بالمنتجات التي تم تحديثها (مثل التأكيد أو الإلغاء).
- `extractRelevantDeliveryKeys`: ترجع قائمة بالمناديب المسؤولين فقط عن شحن أو توصيل المنتجات المعنية.

---

## 3. الفلترة العالمية (Global Actor Filtering)

قاعدة ذهبية: **"لا أحد يتلقى إشعاراً عن فعل قام به هو بنفسه"**.

- **المعرف:** يتم تمرير `actingUserId` (معرف المستخدم الحالي) من واجهات الـ Popups إلى محرك الإشعارات.
- **التطبيق:** في دالتي `notifyOnStepActivation` و `notifyOnSubStepActivation` بملف `notificationTools.js`:
    - يُستثنى المشتري إذا كان هو القائم بالفعل.
    - يتم تصفية مصفوفات البائعين والمناديب لحذف `actingUserId` منها قبل الإرسال.

---

## 4. منطق الإشعارات حسب المراحل

| المرحلة | المستلم المعني | المحتوى |
| :--- | :--- | :--- |
| **تأكيد الطلب** | المشتري + المندوب المعني | "تم تأكيد طلبك / جاري التجهيز للشحن" |
| **شحن الطلب** | المشتري + المندوب المعني | "طلبك في الطريق إليك" |
| **توصيل الطلب** | المشتري + البائع المعني | "تم تسليم الطلب بنجاح" |
| **إلغاء منتج** | البائع (المالك للمنتج فقط) | "قام المشتري بإلغاء بعض منتجاتك" |
| **رفض منتج** | المشتري + المندوب المعني | "تم رفض بعض المنتجات لعدم توفرها" |
| **إرجاع منتج** | البائع المعني فقط | "طلب المشتري إرجاع منتج تابع لك" |

---

## 5. الاعتبارات التقنية والأداء

1. **إرسال متوازي (Parallel Dispatch):** يتم استخدام `Promise.all` لإرسال الإشعارات لجميع الأطراف في وقت واحد لضمان عدم تأثر سرعة واجهة المستخدم.
2. **الاستقلالية:** نظام الإشعارات مفصول تماماً عن منطق حفظ البيانات الأساسي، مما يضمن استمرار عملية الحفظ حتى لو فشل إرسال الإشعار.
3. **الدقة:** تم اختبار النظام في طلبات "متعددة البائعين" و "متعددة المناديب" لضمان عدم وصول إشعار لبائع أو مندوب عن منتجات لا تخصه.
